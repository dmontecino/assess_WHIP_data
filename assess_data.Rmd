---
title: "WHIP DATA QUALITY ASSESSMENT"
output: html_document
params:
  obs: obs
  spec: spec
  env_spec: env_spec
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

```

```{r load packages and data, echo=FALSE, warning=FALSE, message=FALSE}
library(knitr)
library(kableExtra)
library(readxl)
library(stringi)
library(tibble)
library(rworldmap)
library(tidyverse)
library(dplyr)


#Parameters. As countrues are agreggated they need to be added to the following vectors

countries.names=c("Cambodia", "Laos", "Vietnam", "Guatemala", "Peru", "Bolivia")
countries.project.tags=c("Cambodia", "Lao_PDR", "Vietnam", "Guatemala", "Peru", "Bolivia")
years=2019:2100


# which sheets are present = what data was requested
# 
# dat=lapply(c(1:3), function(x) read_excel("/Users/DMontecino/Downloads/WHIP Data export 2023-05-11.xlsx", sheet = x, col_types = "text"))

dat=list(params$obs, params$spec, params$env_spec)

# assigna names to the list elements
names(dat)<-c("obs","spec","env_spec")


dat$obs=dat$obs[!grepl("training", x = dat$obs$observation_project_tags, ignore.case = T),]
dat$spec=dat$spec[!grepl("training", x = dat$spec$specimen_project_tags, ignore.case = T),]
dat$env_spec=dat$env_spec[!grepl("training", x = dat$env_spec$environmental_specimen_project_tags, ignore.case = T),]


```
# EVENTS 
#
#
## COUNTRY OF THE EVENTS 
#
#### Is the country provided for all the events?
#
#
```{r country of the events, echo=FALSE, warning=FALSE, eval=T, cache=F}

# this apply for event.codes.per.country$NA_Country$Projects

event.codes.wo.country=
  lapply(dat, function(x)
  x%>%
    filter(is.na(country)) %>% 
    dplyr::select(event_code, contains("project_tag"))%>%
    distinct())

event.codes.wo.country=
  lapply(event.codes.wo.country, setNames, c("event_code", "project_tag"))

 
if(nrow(do.call(rbind, event.codes.wo.country))>0){  

event.codes.wo.country.df=do.call(rbind, event.codes.wo.country)

colnames(event.codes.wo.country.df)=c("project_tags", "event_code")



event.codes.wo.country.df=
  event.codes.wo.country.df%>%
  group_by(project_tags) %>%
  dplyr::summarise(event_codes = paste(event_code, collapse = ", "))%>%
  arrange(project_tags)
 



    print("No. Not all events have the country provided.
These are the Events without country. The country is provided based on the project tag")

    kableExtra::kbl(event.codes.wo.country.df,
                    caption = "Event codes without country. Country based on project tag") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")}else{#}

    
    print("Yes, all the events have the country assigned")
  
 
  }
  
```
#
#### Does the country, when provided, exist? Or is it a bogus random word?
#
#
```{r check countries, echo=FALSE, warning=FALSE, eval=T, cache=F}

events.no.standard.country=
  lapply(dat,function(z)
  sapply(countries.project.tags, function(x) grepl(x, select(z, contains("project_tags")) %>% pull())))

events.no.standard.country.temp=lapply(events.no.standard.country, function(l)
as_tibble(unlist(apply(l, MARGIN = 1, function(x) if(any(x)){colnames(l)[x]}else{NA}))))

events.no.standard.country.temp=lapply(events.no.standard.country.temp, setNames, "country_from_proj_tag")

events.no.standard.country=mapply(cbind, lapply(dat, function(x) x %>% select(event_code, country)), events.no.standard.country.temp, SIMPLIFY=F)

events.no.standard.country=lapply(events.no.standard.country, function(x) x %>% filter(!country%in%countries.names))




  # create a list with the codes of he events that do have country but is bogus.
  # The country is based on the project tag field
# add the country name to those events with unknown country based on the project tag
if(nrow(do.call(rbind,events.no.standard.country))>0){

events.no.standard.country.df=do.call(rbind, events.no.standard.country)


events.no.standard.country.df=
  events.no.standard.country.df %>% 
  select(event_code, country) %>% 
  distinct() %>% 
  group_by(country) %>%
  dplyr::summarise(event_codes = paste(event_code, collapse = ", "))%>%
  arrange(country)

# Show the results
      
    print("No. Not all the countries provided are acceptable. These are the events without a proper country. The country provided is based on the project tag")
  
    kableExtra::kbl(events.no.standard.country.df, 
                    caption = "Event codes with incorrect country. The country is based on the project tag") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")}else{#}

# if(!exists("events.countries.provided.bogus.per.country.df") |
#     exists("events.countries.provided.bogus.per.country.df") && nrow(events.countries.provided.bogus.per.country.df)==0){  
# 
#    event.codes.bogus.country.per.country=list(data.frame(Country="", Event_Code=""))
#    
#    rownames(event.codes.bogus.country.per.country[[1]])<-NULL
#          
   
    print("Yes, all the countries provided are appropriate")}

  
```
#
## LATITUDE AND LONGITUDE
#
#### Is the Latitude feasible in decimal degrees?
#
#
```{r check latitude, echo=FALSE, warning=FALSE, eval=T, cache=F}


event.codes.wrong.lat=
lapply(dat, function(x)
  x%>%filter(latitude>90 | latitude<(-90))%>%
  dplyr::select(country,event_code)%>%
  distinct(country,event_code))


# if there are rows with wrong latitude
if(nrow(do.call(rbind, event.codes.wrong.lat))>0){  

event.codes.wrong.lat.df=do.call(rbind, event.codes.wrong.lat)


  
event.codes.wrong.lat.df=
  event.codes.wrong.lat.df%>%
  group_by(country) %>%
  dplyr::summarise(event_codes = paste(event_code, collapse = ", "))%>%
  arrange(country)

# Show the results
    
    print("No. Not all the latitudes values reported are feasible. These are the events with impossible latitude values (in decimal degrees)")
    
    kableExtra::kbl(event.codes.wrong.lat.df, 
                    caption = "Event codes with implausible latitude values (in decimal degrees)") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")

    }else{#}


    print("Yes, all the latitude values reported are feasible (in decimal degrees)")}
  
```
#
#### Is the Longitude feasible in decimal degrees?
#
#
```{r check Longitude, echo=FALSE, warning=FALSE, eval=T, cache=F}


event.codes.wrong.lon=
lapply(dat, function(x)
  x%>%filter(longitude>180 | longitude<(-180))%>%
  dplyr::select(country,event_code)%>%
  distinct(country,event_code))


  if(nrow(do.call(rbind, event.codes.wrong.lon))>0){  

event.codes.wrong.lon.df=
  do.call(rbind, event.codes.wrong.lon)



event.codes.wrong.lon.df=
  event.codes.wrong.lon.df%>%
  group_by(country) %>%
  dplyr::summarise(event_codes = paste(event_code, collapse = ", "))%>%
  arrange(country)

  
# Show the results
  
    print("No. Not all the longitude values reported are feasible. These are the events with impossible longitude values
(in decimal degrees)")
    
    kableExtra::kbl(event.codes.wrong.lon.df, 
                    caption = "Event codes with implausible longitude values (in decimal degrees)") %>%    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")
    }else{#}


    print("Yes, all the longitude values reported are feasible (in decimal degrees)")}

```
#
## EVENT DATES
#
#### Are the dates provided for all the events?
#
#
```{r checking start dates of events, echo=FALSE, warning=FALSE, cache=F, eval=T}


# events wo the event date
event.codes.dates.not.provided=
  lapply(dat, function(x)
  x%>%
    filter(is.na(event_date))%>%
    dplyr::select(country,event_code)%>%
    distinct())
    

# if there are rows without the event date
if(nrow(do.call(rbind, event.codes.dates.not.provided))>0){  

event.codes.dates.not.provided.df=
  do.call(rbind, event.codes.dates.not.provided)



  event.codes.dates.not.provided.df=
  event.codes.dates.not.provided.df%>%
  group_by(country) %>%
  dplyr::summarise(event_codes = paste(event_code, collapse = ", "))


  
  print("No. Not all the events have their dates. These are the events without dates")
    
  # table
  kableExtra::kbl(event.codes.dates.not.provided.df, 
                  caption = "Event codes without date") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, width = "50em")%>%
    scroll_box(width = "100%", height = "600px")}else{#}



        print("Yes, dates are provided for all events")}
  
```
#
#### Does the interpretation occurs since the event started?
#
#
```{r interpretation dates, echo=FALSE, warning=FALSE, eval=T, cache=F}


event.codes.date.interpretation.earlier.date=
  lapply(dat, function(x)
  x%>%
    filter(!is.na(interpretation_date))%>%
    filter(!(as.Date(event_date)<=as.Date(interpretation_date)))%>%
    dplyr::select(country,event_code)%>%
    distinct(country,event_code))



# if there are rows with wrong latitude
if(nrow(do.call(rbind, event.codes.date.interpretation.earlier.date))>0){  

event.codes.date.interpretation.earlier.date.df=do.call(
  rbind, event.codes.date.interpretation.earlier.date)


event.codes.date.interpretation.earlier.date.df=
  event.codes.date.interpretation.earlier.date.df%>%
  group_by(country) %>%
  dplyr::summarise(event_codes = paste(event_code, collapse = ", ")) %>% 
  arrange(country)
 

  
# Show the results
  print("No. Not all the interpretations occur since the start date. These are the events with inconsistency between
the interpretation date and the event date")

  kableExtra::kbl(event.codes.date.interpretation.earlier.date.df,
                  caption = "Event codes with inconsistent event date and date of interpretation") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2,  border_right = T, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")
  
  }else{#}
  

   print("Yes, all interpretations occur since the corresponding event date")}

```
#
#
## HISTORY OF THE EVENTS 
# 
#### Is the History of the events provided?

```{r check History, echo=FALSE, warning=FALSE, eval=T, cache=F}

event.codes.no.history=
lapply(dat, function(x)
  x%>%filter(is.na(history))%>%
  dplyr::select(country, event_code)%>%
  distinct(country, event_code))


# if there are rows with wrong latitude
if(nrow(do.call(rbind, event.codes.no.history))>0){  

event.codes.no.history.df=
  do.call(rbind, event.codes.no.history)


event.codes.no.history.df=
  event.codes.no.history.df%>%
  group_by(country) %>%
  dplyr::summarise(event_codes = paste(event_code, collapse = ", ")) %>% 
  arrange(country)  

# Show the results
  
    print("No. Not all the events have the 'history' provided. These are the events with no history")
    
    kableExtra::kbl(event.codes.no.history.df, 
                    caption = "Event codes without history") %>%    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{#}

    
    print("Yes, all the events have the 'history' provided")}

```
#
#
## SUMMARY ISSUES AT THE EVENT LEVEL
#
"Yes" cells indicate problems for the item specified in the corresponding column name.

```{r issues at the event level, echo=FALSE, warning=FALSE, eval=T, cache=F}

#data frame observations, specimens, and environmental specimens withput the 
# funding source project tag provided


#data frame event codes without date

event.codes.dates.not.provided.df=
  do.call(rbind,event.codes.dates.not.provided)

event.codes.dates.not.provided.df$No_date="Yes"


#data frame event codes with the interpretation date before the event started

event.codes.date.interpretation.earlier.date.df=
  do.call(rbind, event.codes.date.interpretation.earlier.date)

event.codes.date.interpretation.earlier.date.df$interp_date_before_start="Yes"



#data frame event codes without country 

event.codes.wo.country.df=do.call(rbind, event.codes.wo.country)

event.codes.wo.country.df$No_country="Yes"

# colnames(event.codes.wo.country.per.country.df)=c("Country", "Event_Code",  "No_country")


#data frame event codes with wrong country
event.codes.bogus.country.df=as_tibble(do.call(rbind, events.no.standard.country))

event.codes.bogus.country.df$Wrong_country="Yes"
  

#data frame event codes wrong lat

event.codes.wrong.lat.df=
  do.call(rbind,event.codes.wrong.lat)

event.codes.wrong.lat.df$Wrong_lat="Yes"

# event.codes.wrong.lat.per.country.df=event.codes.wrong.lat.per.country.df%>%
#   dplyr::select(ountry , Event_Code, Wrong_lat)


#data frame event codes wrong lon

event.codes.wrong.lon.df=
  do.call(rbind,event.codes.wrong.lon)

event.codes.wrong.lon.df$Wrong_lon="Yes"

# event.codes.wrong.lon.df=event.codes.wrong.lon.df%>%
#   dplyr::select(Country , Event_Code, Wrong_lon)

event.codes.no.history.df=
do.call(rbind,event.codes.no.history)

event.codes.no.history.df$No_history="Yes"



# data showing the issues per event code per country
event.codes.with.issues=full_join(event.codes.dates.not.provided.df, 
                                  # event.codes.end.dates.not.provided.per.country.df,     
                                  # by=c("Country", "Event_Code"))


# event.codes.with.issues=full_join(event.codes.with.issues,
                                  event.codes.date.interpretation.earlier.date.df,
                                  by=c("country", "event_code"))

event.codes.with.issues=full_join(event.codes.with.issues,
                                  # event.codes.date.interpretation.earlier.end.date.per.country.df,
                                  # by=c("Country", "Event_Code"))

# event.codes.with.issues=full_join(event.codes.with.issues,
                                  event.codes.wo.country.df,
                                  by=c("event_code"))


event.codes.with.issues=full_join(event.codes.with.issues,
                                  event.codes.bogus.country.df, 
                                  by=c("country", "event_code"))

event.codes.with.issues=full_join(event.codes.with.issues,
                                  event.codes.wrong.lat.df, 
                                  by=c("country", "event_code"))

event.codes.with.issues=full_join(event.codes.with.issues,
                                  event.codes.wrong.lon.df, 
                                  by=c("country", "event_code"))

event.codes.with.issues=full_join(event.codes.with.issues,
                                  event.codes.no.history.df, 
                                  by=c("country", "event_code"))


# event.codes.with.issues=event.codes.with.issues[order(event.codes.with.issues$Country, 
#                                                       event.codes.with.issues$Event_Code),]

event.codes.with.issues=event.codes.with.issues %>% arrange(country, event_code)

# event.codes.with.issues=event.codes.with.issues[event.codes.with.issues$Event_Code!="",]

# rownames(event.codes.with.issues)=NULL

# subset to specific country
# event.codes.with.issues=
#   event.codes.with.issues%>%filter(Country==params$country.of.interest)

if(nrow(event.codes.with.issues)>0){
  
      # removing columns were everything is NA
event.codes.with.issues=event.codes.with.issues%>%dplyr::select_if(~ !all(is.na(.)))
  
  
if(any(is.na(event.codes.with.issues))){event.codes.with.issues[is.na(event.codes.with.issues)]="No"}
  
print("Please scroll down the table below to see the complete dataset")  
  
 kableExtra::kbl(event.codes.with.issues,
                  caption = "Event codes with problems per country") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(c(2:ncol(event.codes.with.issues)), border_right = T, width = "8em")%>%

    # kableExtra::collapse_rows(1)
    scroll_box(width = "100%", height = "600px")

}else{
  
  print("No event codes present problems")}  


```
#
# OBSERVATIONS 
#
#
## FUNDING SOURCE PROJECT TAG PROVIDED
#
#### Do all the observations have the funding source project tag?
#
#
```{r funding project tag provided, echo=FALSE, warning=FALSE, eval=T, message=FALSE}


#events with data wo funding source project tag

observations.funding.source.project.tag.not.provided=
dat$obs %>% 
  filter(!grepl(paste(years, collapse = "|"), dat$obs$observation_project_tags)) %>% 
  select(country, event_code, observation_code) %>% distinct()


if(nrow(observations.funding.source.project.tag.not.provided)>0){
  

observations.funding.source.project.tag.not.provided.df=
  observations.funding.source.project.tag.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", "), .groups = "keep")
    
  
# Show the results
      
    print("No. Not all the observations have funding project tag. These are the observations without a funding project tag")
  
    kableExtra::kbl(observations.funding.source.project.tag.not.provided.df, 
                    caption = " Observations codes without funding agency projec tag") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the observations have the funding project tag")}

  

```
#
## SURVEILLANCE PROJECT TAG PROVIDED
#
#### Do all the observations have the surveillance project tag?
#
#
```{r type of surveillance tag provided, echo=FALSE, warning=FALSE, eval=T, message=FALSE}



observations.surveillance.project.tag.not.provided=
dat$obs %>% 
  filter(!grepl(paste(countries.project.tags, collapse = "|"), dat$obs$observation_project_tags)) %>% 
  select(country, event_code, observation_code) %>% distinct()


if(nrow(observations.surveillance.project.tag.not.provided)>0){
  

observations.surveillance.project.tag.not.provided.df=
  observations.surveillance.project.tag.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", "))
    

  
# Show the results
      
    print("No. Not all the observations have surveillance project tag. These are the observations without a surveillance project tag")
  
    kableExtra::kbl(observations.surveillance.project.tag.not.provided.df, 
                    caption = " Data codes without surveillance project tag") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the observations have the surveillance project tag")}


```
#
## SURVEILLANCE OUTBREAK UNIT
#
#### Do all the observations have the surveillance or outbreak unit?
#
#
```{r surveillance or outbreak unit observations, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

observations.surveillance.unit.not.provided=
dat$obs %>% 
  filter(!grepl("Scanning_", dat$obs$observation_project_tags) &
         is.na(id_surveillance_or_outbreak_unit)) %>% 
  select(country, event_code, observation_code) %>% distinct()


if(nrow(observations.surveillance.unit.not.provided)>0){
  

observations.surveillance.unit.not.provided.df=
  observations.surveillance.unit.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", "))
    

  
# Show the results
      
    print("No. Not all the observations not from scanning surveillance unit have the surveillance or outbreak unit provided. These are the observations without the scanning surveillance")
  
    kableExtra::kbl(observations.surveillance.unit.not.provided.df, 
                    caption = " Data codes without surveillance or outbreak unit") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the observations have the surveillance or outbreak unit")}


```
#
## OBSERVATION IDs PROVIDED 
#
#
#### Do all the observations have the observation id provided?
#
#
```{r observation ids, echo=FALSE, cache=FALSE, eval=F, message=FALSE}

observation.codes.with.observation.ids.as.na=
          dat$obs %>% 
          filter(is.na(observation_id)) %>% 
  select(country, event_code, observation_code) %>% distinct()

if(nrow(observation.codes.with.observation.ids.as.na)>0){  

observation.codes.with.observation.ids.as.na.df=
  observation.codes.with.observation.ids.as.na%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", "))
    

  print("No. Not all observation IDs are provided. These are the observations whose observation IDs are NA")
  
  kableExtra::kbl(observation.codes.with.observation.ids.as.na.df, 
                      caption = "Observations with no Observation ID") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{

    print("Yes, all observation IDs are provided")}

```
<!-- # -->
<!-- ## OBSERVATION ID UNIQUE FOR A SINGLE OBSERVATION -->
<!-- # -->
<!-- #### Do all the observations have a unique observation id?  -->
<!-- # -->
<!-- # -->
<!-- ```{r observation ids unique, echo=FALSE, warning=FALSE, cache=FALSE, eval=F, message = FALSE} -->

<!-- # each specimen code has a single animal id? -->

<!-- observation.codes.with.more.than.one.animal.ids= -->
<!--   dat$obs %>%  -->
<!--   filter(!is.na(observation_id))%>% -->
<!--   distinct(observation_code, observation_id) %>%  -->
<!--   count(observation_id) %>%  -->
<!--   filter(n>1)%>% -->
<!--   pull(observation_id) -->

<!-- observation.codes.with.more.than.one.animal.ids= -->
<!--   dat$spec %>%  -->
<!--   filter(observation_id %in% observation.codes.with.more.than.one.animal.ids) %>%  -->
<!--   dplyr::select(country, event_code, observation_code, observation_id) %>%  -->
<!--   distinct() %>%  -->
<!--   arrange(observation_id) -->



<!-- if(nrow(observation.codes.with.more.than.one.animal.ids)>0){   -->

<!-- observation.codes.with.more.than.one.animal.ids.df= -->
<!--   observation.codes.with.more.than.one.animal.ids%>% -->
<!--   group_by(country, observation_id) %>% -->
<!--   dplyr::summarise( -->
<!--     event_codes = paste(event_code, collapse = ", "),  -->
<!--     specimen_codes = paste(observation_code, collapse = ", ")) %>%  -->
<!--   arrange(country)   -->


<!--   print("No, not all observation IDs are under a single observation code. These are observations ids for more than one observation") -->


<!--     kableExtra::kbl(observation.codes.with.more.than.one.animal.ids.df,  -->
<!--                     caption = "Observation Ids in more than one observation code") %>% -->
<!--       kableExtra::kable_paper(full_width = F) %>% -->
<!--       kableExtra::column_spec(1, bold = T, border_right = T) %>%             -->
<!--       kableExtra::column_spec(2, bold = T, border_right = T) %>% -->
<!--       kableExtra::column_spec(3, width = "50em") %>%  -->
<!--       kableExtra::column_spec(4, width = "50em")%>% -->
<!--       scroll_box(width = "100%", height = "600px")}else{#} -->

<!--         print("Yes, all observation ids are used for a single observation")} -->

<!-- ``` -->
#
## OBSERVATIONS WITH DATE OBSERVED
#
#
#### Do all observations have the date they were observed provided?
#
#
```{r observation date provided, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

obs.codes.date.observed.provided=
dat$obs%>%
    filter(is.na(observation_date))%>%
    dplyr::select(country, event_code, observation_code)%>%
    distinct()#)

if(nrow(obs.codes.date.observed.provided)>0){  


obs.codes.date.observed.provided.df=
  obs.codes.date.observed.provided %>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  
  print("No, the data show that some observations do not have the date observed. These are the observations are missing the date they were observed")
  
  kableExtra::kbl(obs.codes.date.observed.provided.df, 
                  caption = "Observations without the date they were observed")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all observations have the date they were observed")}
 
```
#
## OBSERVATIONS MADE SINCE THE EVENT DATE
#
#
#### Were all observations made since the corresponding event date?
#
#
```{r observation date, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

obs.codes.date.found.earlier.date=
  # lapply(dat, function(x)
dat$obs%>%
    filter(!(as.Date(event_date)<=as.Date(observation_date)))%>%
    dplyr::select(country, event_code, observation_code)%>%
    distinct()#)



if(nrow(obs.codes.date.found.earlier.date)>0){  


obs.codes.date.found.earlier.date.df=
  obs.codes.date.found.earlier.date%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  
  print("No, the data show that some observations were observed before the event. These are the observations that were observed earlier than the event")
  
  kableExtra::kbl(obs.codes.date.found.earlier.date.df, 
                  caption = "Observations with inconsistency between the event date and the date they were observed")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all observations were found since the corresponding event")}
  
```
#
## OBSERVATION DETAILS
#
#
#### Do all the observations have the details provided?
#
#
```{r observation details, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

observation.no.details=dat$obs %>% 
  filter(is.na(observation_details)) %>% 
  select(country, event_code, observation_code) %>% 
  distinct()


if(nrow(observation.no.details)>0){  

observation.no.details.df=
  observation.no.details%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  
  print("No, not all observations have details. These are the observations that do not have details provided")
  
  kableExtra::kbl(observation.no.details.df, 
                  caption = "Observations without details provided")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all observations have the details provided")}
  
```
#
## OBSERVATION OBSERVER
#
#
#### Do all the observations have the observer provided?
#
#
```{r observation observer, echo=FALSE, warning=FALSE, eval=T}

observation.no.observer=dat$obs %>%
  filter(is.na(observed_by)) %>%
  select(country, event_code, observation_code) %>%
  distinct()


if(nrow(observation.no.observer)>0){

observation.no.observer.df=
  observation.no.observer%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>%
  arrange(country)


  print("No, not all observations have the observer These are the observations that do not have the observer provided")

  kableExtra::kbl(observation.no.details.df,
                  caption = "Observations without details provided")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)

  }else{#}


  print("Yes, all observations have the observer provided")}

```
#
## OBSERVATION CAPTIVITY CATEGORY
#
#
#### Do all the observations have the funding source project tag?
#
#
```{r observation captivity category, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

observation.no.captivity.category=dat$obs %>% 
  filter(is.na(observation_captivity_category)) %>% 
  select(country, event_code, observation_code) %>% 
  distinct()


if(nrow(observation.no.captivity.category)>0){  

observation.no.captivity.category.df=
  observation.no.captivity.category%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  
  print("No, not all observations have the captivity category. These are the observations that do not have captivity category provided")
  
  kableExtra::kbl(observation.no.captivity.category.df, 
                  caption = "Observations without captivity category provided")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all observations have the captivity category provided")}
  
```
#
## OBSERVATION CLINICAL SIGNS
#
#
#### Do all observations have the clinical signs provided?
#
#
```{r observation clinical signs, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

observation.no.clinical.signs=dat$obs %>% 
  filter(is.na(observation_clinical_signs)) %>% 
  select(country, event_code, observation_code) %>% 
  distinct()


if(nrow(observation.no.clinical.signs)>0){  

observation.no.clinical.signs.df=
  observation.no.clinical.signs%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, not all observations have the clinical signs. These are the observations that do not have clinical signs provided")
  
  kableExtra::kbl(observation.no.clinical.signs.df, 
                  caption = "Observations without clinical signs provided")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all observations have the clinical signs provided")}
  
```
#
## OBSERVATION NUMBERS
#
#
#### Is there at least one individual reported per observation?
#
#
```{r observation at least one, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

total.obs.healthy.sick.dead.is.zero=dat$obs %>% 
  dplyr::select(country, event_code, observation_code, # select the columns of interest
                  observation_number_healthy,
                  observation_number_sick,
                  observation_number_dead)%>%
  mutate_at(vars(contains("observation_number")), as.numeric) %>%  #change the columns with "observation_number" to numeric
  mutate(obs.healthy.sick.dead =rowSums(select(., contains("observation_number")))) %>% #sum the numbers in the columns that have "observation_number" per row
  filter(obs.healthy.sick.dead==0) %>% # select the rows wherre the total number of animals is zero
  select(country, event_code, observation_code) %>% #select columns
  distinct() #unique combinations


if(nrow(total.obs.healthy.sick.dead.is.zero)>0){  

total.obs.healthy.sick.dead.is.zero.df=
  total.obs.healthy.sick.dead.is.zero%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  
  


  print("No. Not all observations have at least one individual reported. These are the observations without animals")
  
  kableExtra::kbl(total.obs.healthy.sick.dead.is.zero.df, 
                      caption = "Observations without individuals") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all observations have at least one individual")}

```
#
#### Does total seen match the sum of number healthy, number sick, and number dead?
#
#
```{r observation number, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

obs.healthy.sick.dead.not.equal.observed.sum=dat$obs %>% 
  dplyr::select(country, event_code, observation_code, # select the columns of interest
                  observation_total_number_observed,
                  observation_number_healthy,
                  observation_number_sick,
                  observation_number_dead)%>%
  mutate_at(vars(contains("_number_")), as.numeric) %>%  #change the columns with "observation_number" to numeric
  mutate(obs.healthy.sick.dead =rowSums(select(., contains("observation_number")))) %>% #sum the numbers in the columns that have "observation_number" per row
  filter(obs.healthy.sick.dead!=observation_total_number_observed) %>% # select the rows wherre the total number of animals is zero
  select(country, event_code, observation_code) %>% #select columns
  distinct() #unique combinations


if(nrow(obs.healthy.sick.dead.not.equal.observed.sum)>0){  

  obs.healthy.sick.dead.not.equal.observed.sum.df=
  obs.healthy.sick.dead.not.equal.observed.sum%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  print("No. Not all total observed and the sum of the number of healthy, sick, and dead observed individuals match. These are the observations with values that do not match")
  
  kableExtra::kbl(obs.healthy.sick.dead.not.equal.observed.sum.ef, 
                      caption = "Observations with incongruent numbers of individuals") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{

    print("Yes, all observations have correct consistent numbers")}


```
#
#### Do all observations represent a single species?
#
#
```{r checking observation single sps, echo=FALSE, cache=FALSE, eval=T, message=FALSE}

observation.codes.unique.sps=
  
  dat$obs %>% 
  dplyr::select(country, event_code, 
                observation_code, # select the columns of interest
                observation_common_name) %>% 
      dplyr::group_by(observation_code)%>%
      dplyr::mutate(num.species=n()) %>% 
      filter(num.species>1)%>%
      select(country, event_code, observation_code) %>% #select columns
      distinct() #unique combinations

    
if(nrow(observation.codes.unique.sps)>0){  

observation.codes.unique.sps.df=
  observation.codes.unique.sps%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  


  print("No. Not all observation represent a single species. These are the observations with with more than one species")
  
  kableExtra::kbl(observation.codes.unique.sps.df, 
                      caption = "Observations with more than one species") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{#}


    print("Yes, all observations represent a single species")}

```
#
## OBSERVATION SPECIES PROVIDED
#
#
#### Do all observations have a species assigned?
#
#
```{r observation species, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

obs.species.not.reported=

dat$obs%>%
    filter(is.na(observation_common_name)) %>% 
    dplyr::select(country, event_code, observation_code)%>%
    distinct()


if(nrow(obs.species.not.reported)>0){  

obs.species.not.reported.df=
  obs.species.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some observations do not have the species. These are the Observation codes that do not have the species reported")
  
  kableExtra::kbl(obs.species.not.reported.df, 
                  caption = "Observation species not provided")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all observations have species reported")}
  

```
#
## TENTATIVE DIAGNOSIS FOR THE OBSERVED SPECIES
#
#
#### Is the category of Tentative Diagnosis provided?
#
#
```{r tentative diagnosis category observations, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message = FALSE}

observation.category.tentative.diagnosis.not.provided=
  
  dat$obs %>% 
  dplyr::select(country, event_code, 
                observation_code, # select the columns of interest
                observation_tentative_category_of_diagnosis) %>% 
      filter(is.na(observation_tentative_category_of_diagnosis))%>%
      select(country, event_code, observation_code) %>% #select columns
      distinct() #unique combinations


if(nrow(observation.category.tentative.diagnosis.not.provided)>0){  

  observation.category.tentative.diagnosis.not.provided.df=
  observation.category.tentative.diagnosis.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  print("No. Not all observations have a tentative category of diagnosis provided")
  
  kableExtra::kbl(observation.category.tentative.diagnosis.not.provided.df, 
                      caption = "Observations without a category of tentative diagnosis") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")
}else{

    print("Yes, all observations have a category of tentative diagnosis")}
```
#
#### Is the Tentative Diagnosis provided?
#
#
```{r tentative diagnosis observations, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message = FALSE}

observation.tentative.diagnosis.not.provided=
  
  dat$obs %>% 
  dplyr::select(country, event_code, 
                observation_code, # select the columns of interest
                observation_tentative_diagnosis) %>% 
      filter(is.na(observation_tentative_diagnosis))%>%
      select(country, event_code, observation_code) %>% #select columns
      distinct() #unique combinations %>% 



if(nrow(observation.tentative.diagnosis.not.provided)>0){  

  observation.tentative.diagnosis.not.provided.df=
  observation.tentative.diagnosis.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  print("No. Not all observations have the tentative diagnosis provided")
  
  kableExtra::kbl(observation.tentative.diagnosis.not.provided.df, 
                      caption = "Observations without the tentative diagnosis") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{

    print("Yes, all observations have a tentative diagnosis")}
```
#
#### Is the Tentative Diagnosis Date provided?
#
#
```{r tentative diagnosis date for observations provided, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message = FALSE}

observation.tentative.diagnosis.date.not.provided=
  
  dat$obs %>% 
      filter(is.na(observation_tentative_diagnosis_date))%>%
      select(country, event_code, observation_code) %>%
      distinct() #unique combinations


if(nrow(observation.tentative.diagnosis.date.not.provided)>0){  

  observation.tentative.diagnosis.date.not.provided.df=
  observation.tentative.diagnosis.date.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  print("No. Not all observations have the tentative diagnosis date provided")
  
  kableExtra::kbl(observation.tentative.diagnosis.date.not.provided.df, 
                      caption = "Observations without tentative diagnosis date") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{

    print("Yes, all observations have a tentative diagnosis date provided")}
```
#
#### Does the Tentative Diagnosis occur since the event date?
#
#
```{r tentative diagnosis observations since the event date, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message = FALSE}

observation.tentative.diagnosis.date.before.event.date=
  
  dat$obs %>% 
      filter(!is.na(observation_tentative_diagnosis_date) &
             !as.Date(observation_tentative_diagnosis_date)>=as.Date(event_date))%>%
      select(country, event_code, observation_code) %>% #select columns
      distinct() #unique combinations


if(nrow(observation.tentative.diagnosis.date.before.event.date)>0){  

  observation.tentative.diagnosis.date.before.event.date.df=
  observation.tentative.diagnosis.date.before.event.date%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  print("No. Not all the tentative diagnosis were provided since the event date")
  
  kableExtra::kbl(observation.tentative.diagnosis.date.before.event.date.df, 
                      caption = "Observations with tentative diagnosies provided earlier than the event date") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{

    print("Yes, all the tentative diagnosis date were provided since the event date")}
```
#
#### Does the Tentative Diagnosis occur since the Observation date?
#
#
```{r tentative diagnosis observations since the observation date, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message = FALSE}

observation.tentative.diagnosis.date.before.observation.date=
  
  dat$obs %>% 
  dplyr::select(country, event_code, 
                observation_code, # select the columns of interest
                observation_date,
                observation_tentative_diagnosis_date) %>% 
      filter(!is.na(observation_tentative_diagnosis_date) &
             !as.Date(observation_tentative_diagnosis_date)>=as.Date(observation_date))%>%
      select(country, event_code, observation_code) %>% #select columns
      distinct() #unique combinations


if(nrow(observation.tentative.diagnosis.date.before.observation.date)>0){  

  observation.tentative.diagnosis.date.before.observation.date.df=
  observation.tentative.diagnosis.date.before.observation.date%>%
  group_by(country, event_code) %>%
  dplyr::summarise(observation_codes = paste(observation_code, collapse = ", ")) %>% 
  arrange(country)  

  print("No. Not all observations that have the tentative diagnosis date have a tentative diagnosis date since they were observed")
  
  kableExtra::kbl(observation.tentative.diagnosis.date.before.observation.date.df, 
                      caption = "Observations whose tentative diagnosis date is earlier than the observation date") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{

    print("Yes, for all the observations that have a tentative diagnosis date, it is since the observation date")}
```
<!-- # -->
<!-- #### Observations with Tentative Diagnosis "Infectious Disease" have a Suspected Pathogen -->
<!-- # -->
<!-- ```{r tentative diagnosis "observations"infectious disease" have suspected pathogen, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message = FALSE} -->


<!-- ``` -->
<!-- # -->
<!-- #### Observations with a Suspected Pathogen have a "based on" criteria -->
<!-- # -->
<!-- ```{r tentative diagnosis "observations" suspected pathogen have based criteria, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message = FALSE} -->


<!-- ``` -->

#
## SUMMARY ISSUES AT THE OBSERVATION LEVEL
#
"Yes" cells indicate problems for the item specified in the corresponding column name. Absence of a table below means that there are not issues at the observation level.#
```{r issues observation level, echo=FALSE, warning=FALSE, eval=T, cache=F}


#data frame event codes without fundgin project tag

observations.funding.source.project.tag.not.provided$No_fundings_project_tag="Yes"

#data frame event codes without surveillance project tag

observations.surveillance.project.tag.not.provided$No_surveillance_project_tag="Yes"

#data frame observaetion codes without surveillance or outbreak unit

observations.surveillance.unit.not.provided$No_surveillance_outbreak_unit="Yes"

#data frame observaetion codes without observed date

obs.codes.date.observed.provided$No_observed_date="Yes"

#data frame observaetion codes observed earlier than event date

obs.codes.date.found.earlier.date$Observed_before_event_date="Yes"

#data frame observation codes without details

observation.no.details$No_details="Yes"

#data frame observation codes without observer

observation.no.observer$No_observer="Yes"

#data frame observation codes without captivity category

observation.no.captivity.category$No_captivity_cat="Yes"

#data frame observation codes without clinical signs

observation.no.clinical.signs$No_clinical_signs="Yes"

#data frame observation withput animals 

total.obs.healthy.sick.dead.is.zero$No_animals="Yes"

#data frame observation incosistent total animals versus age*health*sex categories

obs.healthy.sick.dead.not.equal.observed.sum$Inconsistent_numbers="Yes"

#data frame observations with more than one species

observation.codes.unique.sps$More_one_species="Yes"

#data frame observations with species not reported

obs.species.not.reported$No_species="Yes"

#data frame observations without tentative diagnosis category

observation.category.tentative.diagnosis.not.provided$No_tentative_diag_cat="Yes"

#data frame observations without tentative diagnosis

observation.tentative.diagnosis.not.provided$No_tentative_diag_given="Yes"

#data frame observations without tentative diagnosis date

observation.tentative.diagnosis.date.not.provided.df$No_tentative_diag_date="Yes"

#data frame observations with tentative diagnosis date before the event date

observation.tentative.diagnosis.date.before.event.date$Tentative_diag_date_before_event_date="Yes"

#data frame observations with tentative diagnosis date before the observation date

observation.tentative.diagnosis.date.before.observation.date$Tentative_diag_date_before_obs_date="Yes"



# data showing the issues per event code per country
observation.codes.with.issues=full_join(observations.funding.source.project.tag.not.provided, 
                                  observations.surveillance.project.tag.not.provided,
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observations.surveillance.unit.not.provided,
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  obs.codes.date.observed.provided,
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  obs.codes.date.found.earlier.date,
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.no.details, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.no.observer, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.no.captivity.category, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.no.clinical.signs, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  total.obs.healthy.sick.dead.is.zero, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  obs.healthy.sick.dead.not.equal.observed.sum, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.codes.unique.sps, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  obs.species.not.reported, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.category.tentative.diagnosis.not.provided, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.tentative.diagnosis.not.provided, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.tentative.diagnosis.date.not.provided, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.tentative.diagnosis.date.before.event.date, 
                                  by=c("country", "event_code", "observation_code"))

observation.codes.with.issues=full_join(observation.codes.with.issues,
                                  observation.tentative.diagnosis.date.before.observation.date, 
                                  by=c("country", "event_code", "observation_code"))


observation.codes.with.issues=observation.codes.with.issues %>% arrange(country, event_code)


if(nrow(observation.codes.with.issues)>0){
  
      # removing columns were everything is NA
observation.codes.with.issues=observation.codes.with.issues%>%dplyr::select_if(~ !all(is.na(.)))
  
  
if(any(is.na(observation.codes.with.issues))){observation.codes.with.issues[is.na(observation.codes.with.issues)]="No"}
  
print("Please scroll down the table below to see the complete dataset")  
  
 kableExtra::kbl(observation.codes.with.issues,
                  caption = "Observations codes with problems") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(c(2:ncol(observation.codes.with.issues)), border_right = T, width = "8em")%>%
    scroll_box(width = "100%", height = "600px")

}else{
  
  print("No observation codes present problems")}  


```
#
# SPECIMENS 
#
#
## FUNDING SOURCE PROJECT TAG PROVIDED
#
#### Do all the specimens have the funding source project tag?
#
#
```{r funding project tag provided specimens, echo=FALSE, warning=FALSE, eval=T, message=FALSE}


#events with data wo funding source project tag

specimens.funding.source.project.tag.not.provided=
dat$spec %>% 
  filter(!grepl(paste(years, collapse = "|"), dat$spec$specimen_project_tags)) %>% 
  select(country, event_code, specimen_code) %>% distinct()


if(nrow(specimens.funding.source.project.tag.not.provided)>0){
  

specimens.funding.source.project.tag.not.provided.df=
  specimens.funding.source.project.tag.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", "))
    
  
# Show the results
      
    print("No. Not all the specimens have funding project tag. These are the specimens without a funding project tag")
  
    kableExtra::kbl(specimens.funding.source.project.tag.not.provided.df, 
                    caption = " specimens codes without funding agency projec tag") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the specimens have the funding project tag")}

  

```
#
## SURVEILLANCE PROJECT TAG PROVIDED
#
#### Do all the specimens have the surveillance project tag?
#
#
```{r type of surveillance tag provided specimens, echo=FALSE, warning=FALSE, eval=T, message=FALSE}



specimens.surveillance.project.tag.not.provided=
dat$spec %>% 
  filter(!grepl(paste(countries.project.tags, collapse = "|"), dat$spec$specimen_project_tags)) %>% 
  select(country, event_code, specimen_code) %>% distinct()


if(nrow(specimens.surveillance.project.tag.not.provided)>0){
  

specimens.surveillance.project.tag.not.provided.df=
  specimens.surveillance.project.tag.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", "))
    

  
# Show the results
      
    print("No. Not all the specimens have surveillance project tag. These are the specimens without a surveillance project tag")
  
    kableExtra::kbl(specimens.surveillance.project.tag.not.provided.df, 
                    caption = " Data codes without surveillance project tag") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the specimens have the surveillance project tag")}


```
#
## SURVEILLANCE OUTBREAK UNIT
#
#### Do all the speicmens have the surveillance or outbreak unit?
#
#
```{r surveillance or outbreak unit specimens, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

spec.surveillance.unit.not.provided=
dat$spec %>% 
  filter(!grepl("Scanning_", dat$spec$specimen_project_tags) &
         is.na(id_surveillance_or_outbreak_unit)) %>% 
  select(country, event_code, specimen_code) %>% distinct()


if(nrow(spec.surveillance.unit.not.provided)>0){
  

spec.surveillance.unit.not.provided.df=
  spec.surveillance.unit.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", "))
  
# Show the results
      
    print("No. Not all the specimens not from scanning surveillance unit have the surveillance or outbreak unit provided. These are the specimens without the scanning surveillance")
  
    kableExtra::kbl(spec.surveillance.unit.not.provided.df, 
                    caption = " Data codes without surveillance or outbreak unit") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the specmens have the surveillance or outbreak unit")}


```
#
## ANIMAL IDs PROVIDED 
#
#
#### Do all the speicmens have the animal ids provided?
#
#
```{r animal ids, echo=FALSE, cache=FALSE, eval=T, message=FALSE}

specimen.codes.with.animal.ids.as.na=
          dat$spec %>% 
          filter(is.na(animal_id)) %>% 
  select(country, event_code, specimen_code) %>% distinct()

if(nrow(specimen.codes.with.animal.ids.as.na)>0){  

specimen.codes.with.animal.ids.as.na.df=
  specimen.codes.with.animal.ids.as.na%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", "))
    

  print("No. Not all animal IDs are provided. These are the specimens whose animal IDs are NA")
  
  kableExtra::kbl(specimen.codes.with.animal.ids.as.na.df, 
                      caption = "Specimens with no Animal IDs") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{

    print("Yes, all animal IDs are provided")}

```
#
## ANIMAL ID UNIQUE FOR A SINGLE SPECIMEN
#
#### Do all the specimens have a unique animal id? 
#
#
```{r animal ids unique, echo=FALSE, warning=FALSE, cache=FALSE, eval=T, message = FALSE}

# each specimen code has a single animal id?

specimen.codes.with.more.than.one.animal.ids=
  dat$spec %>% 
  filter(!is.na(animal_id))%>%
  distinct(specimen_code, animal_id) %>% 
  count(animal_id) %>% 
  filter(n>1)%>%
  pull(animal_id)

specimen.codes.with.more.than.one.animal.ids=
  dat$spec %>% 
  filter(animal_id %in% specimen.codes.with.more.than.one.animal.ids) %>% 
  dplyr::select(country, event_code, specimen_code, animal_id) %>% 
  distinct() %>% 
  arrange(animal_id)


  
if(nrow(specimen.codes.with.more.than.one.animal.ids)>0){  

specimen.codes.with.more.than.one.animal.ids.df=
  specimen.codes.with.more.than.one.animal.ids%>%
  group_by(country, animal_id) %>%
  dplyr::summarise(
    event_codes = paste(event_code, collapse = ", "), 
    specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
    
    
  print("No, not all animal IDs are under a single specimen code. These are animal IDs for more than one specimen")

    
    kableExtra::kbl(specimen.codes.with.more.than.one.animal.ids.df, 
                    caption = "Animal IDs in more than one specimen code") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%            
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "50em") %>% 
      kableExtra::column_spec(4, width = "50em")%>%
    scroll_box(width = "100%", height = "600px")}else{#}

        print("Yes, all animal IDs are used for a single specimen")}

```

<!-- # -->
<!-- # -->
<!-- ##### Do the Animal IDs follow the standardized labeling structure? -->
<!-- # -->
<!-- # ```{r checking animal ids 2, echo=FALSE, warning=FALSE, cache=FALSE, eval=F} -->
<!-- #  -->
<!-- # # Structure of animal IDs follow the standardized frame -->
<!-- # country.abbreviations=c("KH", "LA", "VN") -->
<!-- #  -->
<!-- # project.abbreviations=c("W") -->
<!-- #  -->
<!-- # taxa=list(A="Amphibian", B="Bat", C="Carnivore", -->
<!-- #           E="Elephant", F="Fish", G="Pangolin", -->
<!-- #           L="Reptile", M="Marine mammal", P="Primate", -->
<!-- #           R="Rodent", S="Swine", U="Ungulate", -->
<!-- #           W="Wild bird", X="Environmental") -->
<!-- #  -->
<!-- # project.country.abbreviations=paste0(rep(project.abbreviations, -->
<!-- #                                          each = length(country.abbreviations)) -->
<!-- #                                      , country.abbreviations, "-") -->
<!-- #  -->
<!-- # # first part of animal ids when they are not NA -->
<!-- # first.part.animal.ids.project.country.hyphen= # one letter for project, 2 letters for country, and hyphen -->
<!-- #   substr(spec[!is.na(spec$Animal_ID),]$Animal_ID, 1,4)  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # # in the first part of the label -->
<!-- # first.part.animal.ids.is.correct=all( -->
<!-- #    -->
<!-- #   substring(first.part.animal.ids.project.country.hyphen, 1,1)%in%project.abbreviations & # first piece does have a valid project letter? -->
<!-- #      -->
<!-- #     substring(first.part.animal.ids.project.country.hyphen, 2,3)%in%country.abbreviations & # second piece has valid country abbreviations? -->
<!-- #      -->
<!-- #     substring(first.part.animal.ids.project.country.hyphen, 4)=="-") # third piece is a hyphen?  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # #in the second part of the label -->
<!-- # second.part.animal.ids.taxa.numeric=  # one letter for taxa, 3 numbers -->
<!-- #   sapply(strsplit(spec[!is.na(spec$Animal_ID),]$Animal_ID, "-"), function(x) x[2]) -->
<!-- #  -->
<!-- #  -->
<!-- # #id second part of the animal id structure -->
<!-- # second.part.animal.ids.is.correct=all( -->
<!-- #    -->
<!-- #   substring(second.part.animal.ids.taxa.numeric, 1,1)%in%names(taxa) & # first piece does have a valid taxa letter? -->
<!-- #      -->
<!-- #     !is.na(as.numeric(substring(second.part.animal.ids.taxa.numeric, 2,4)))) # second piece: cgaracters 2 to 4 can be moved to a number -->
<!-- #  -->
<!-- #  -->
<!-- # wrong.animal.id.first.part= -->
<!-- #    -->
<!-- #   spec[!is.na(spec$Animal_ID),]$Animal_ID[ -->
<!-- #      -->
<!-- #     !(substring(first.part.animal.ids.project.country.hyphen, 1,1)%in%project.abbreviations) | # first piece does have a valid project letter? -->
<!-- #        -->
<!-- #       !(substring(first.part.animal.ids.project.country.hyphen, 2,3)%in%country.abbreviations) | # second piece has valid country abbreviations? -->
<!-- #        -->
<!-- #       substring(first.part.animal.ids.project.country.hyphen, 4)!="-"] -->
<!-- #    -->
<!-- #    -->
<!-- # wrong.animal.id.second.part= -->
<!-- #    -->
<!-- #   spec[!is.na(spec$Animal_ID),]$Animal_ID[ -->
<!-- #      -->
<!-- #     !(substring(second.part.animal.ids.taxa.numeric, 1,1)%in%names(taxa)) | # first piece does have a valid taxa letter? -->
<!-- #        -->
<!-- #       is.na(as.numeric(substring(second.part.animal.ids.taxa.numeric, 2,4)))] -->
<!-- #    -->
<!-- #    -->
<!-- # wrong.animal.id=sort(unique(wrong.animal.id.first.part, wrong.animal.id.second.part)) -->
<!-- #    -->
<!-- #   -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country= -->
<!-- # lapply(data.per.country.spec, function(x) -->
<!-- # x%>% -->
<!-- #   filter(!is.na(Animal_ID) & Animal_ID%in%wrong.animal.id)%>% -->
<!-- #   dplyr::select(Country, Specimen_code)%>% -->
<!-- #   distinct(Country, Specimen_code)) -->
<!-- #  -->
<!-- #    -->
<!-- # if(nrow(do.call(rbind, specimen.codes.with.wrong.animal.ids.per.country))>0){   -->
<!-- #  -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country= -->
<!-- #   do.call( -->
<!-- #   rbind, specimen.codes.with.wrong.animal.ids.per.country)%>% -->
<!-- #   dplyr::select(Country, Specimen_code) -->
<!-- #  -->
<!-- # # spit the data by country again now including the data of country based on the project tag -->
<!-- # # for those rows wo country -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country= -->
<!-- # lapply(sort(unique(specimen.codes.with.wrong.animal.ids.per.country$Country)), function(x)  -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country%>%filter(Country==x)%>% -->
<!-- #   dplyr::select(Country, Specimen_code)%>% -->
<!-- #   distinct(Country, Specimen_code)) -->
<!-- #  -->
<!-- # # name the list -->
<!-- # names(specimen.codes.with.wrong.animal.ids.per.country)=sapply( -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country, function(x) unique(x$Country)) -->
<!-- #      -->
<!-- # # order by specimen code -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country= -->
<!-- #   lapply(specimen.codes.with.wrong.animal.ids.per.country, function(x) -->
<!-- #   x[order(x[,"Specimen_code"]), ]) -->
<!-- #  -->
<!-- # # move to da dataset with the event codes in a single row -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country.df= -->
<!-- #   lapply(specimen.codes.with.wrong.animal.ids.per.country, function(x) -->
<!-- #   data.frame(Specimen_code=paste(unique(x$Specimen_code), collapse = " "))) -->
<!-- #  -->
<!-- #  -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country.df=data.frame( -->
<!-- #     Country=names(specimen.codes.with.wrong.animal.ids.per.country.df),  -->
<!-- #     Specimen_code=unlist(specimen.codes.with.wrong.animal.ids.per.country.df, use.names = F)) -->
<!-- #  -->
<!-- #    specimen.codes.with.wrong.animal.ids.per.country.df= -->
<!-- #      specimen.codes.with.wrong.animal.ids.per.country.df[ -->
<!-- #        specimen.codes.with.wrong.animal.ids.per.country.df$Specimen_code!="",] -->
<!-- #  -->
<!-- #    #delete rownames -->
<!-- #   rownames(specimen.codes.with.wrong.animal.ids.per.country.df)=NULL -->
<!-- #    -->
<!-- #         # subset to specific country -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country.df= -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country.df%>%filter(Country==params$country.of.interest) -->
<!-- #  -->
<!-- # if(nrow(specimen.codes.with.wrong.animal.ids.per.country.df)>0){ -->
<!-- #  -->
<!-- #    -->
<!-- #     print("No. Not all animal IDs provided follow the label format. These are the animal IDs with wrong format. Please -->
<!-- # scroll the table below down and left-right to see the complete dataset if needed", appendLF = T) -->
<!-- #      -->
<!-- #   kableExtra::kbl(specimen.codes.with.wrong.animal.ids.per.country.df,  -->
<!-- #                   caption = "Specimen codes with wrong Animal IDs per country") %>% -->
<!-- #     kableExtra::kable_paper(full_width = F) %>% -->
<!-- #     kableExtra::column_spec(1, bold = T, border_right = T) %>% -->
<!-- #     kableExtra::column_spec(2, width = "30em") -->
<!-- #  -->
<!-- # }} -->
<!-- #  -->
<!-- # if(!exists("specimen.codes.with.wrong.animal.ids.per.country.df") | -->
<!-- #     exists("specimen.codes.with.wrong.animal.ids.per.country.df") &&  -->
<!-- #    nrow(specimen.codes.with.wrong.animal.ids.per.country.df)==0){   -->
<!-- #  -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country=list(data.frame(Country="", Observation_code="")) -->
<!-- #     -->
<!-- #   rownames(specimen.codes.with.wrong.animal.ids.per.country[[1]])<-NULL -->
<!-- #      -->
<!-- #      -->
<!-- #   print("Yes, all animal IDs provided have the correct format")} -->
<!-- #  -->
<!-- # ``` -->
#
## SPECIMENS WITH DATE FOUND
#
#
#### Do all specimens have the date they were found provided?
#
#
```{r speciemens date found provided, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

spec.codes.date.found.provided=
dat$spec%>%
    filter(is.na(date_found)) %>% 
    dplyr::select(country, event_code, specimen_code, date_found)%>%
    distinct()#)

if(nrow(spec.codes.date.found.provided)>0){  


spec.codes.date.found.provided.df=
  spec.codes.date.found.provided %>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  

  
  print("No, the data show that some specimens do not have the date found These are the specimens are missing the date they were found")
  
  kableExtra::kbl(spec.codes.date.found.provided.df, 
                  caption = "Specimens without the date they were found")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)
  
  }else{#}


  print("Yes, all specimens have the date they were found")}
 
```
#
## SPECIMENS FOUND SINCE THE EVENT DATE
#
#
#### Were all specimens found since the corresponding event date?
#
#
```{r specimen date, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

spec.codes.date.found.earlier.date=
  # lapply(dat, function(x)
dat$spec%>%
    filter(!(as.Date(event_date)<=as.Date(date_found)))%>%
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()#)

if(nrow(spec.codes.date.found.earlier.date)>0){  

spec.codes.date.found.earlier.date.df=
  spec.codes.date.found.earlier.date%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  

  
  print("No, the data show that some specimens were found before the event. These are the specimens that were found earlier than the event")
  
  kableExtra::kbl(spec.codes.date.found.earlier.date.df, 
                  caption = "Specimens with inconsistency between the event date and the date they were found")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens were found since the corresponding event")}
  
```
<!-- # -->
<!-- # -->
<!-- ##### Were the specimens received since the date they were found? -->
<!-- # -->
<!-- ```{r specimen date 3, echo=FALSE, warning=FALSE, eval=F, cache=FALSE} -->

<!-- spec.received.earlier.than.found.date.per.country= -->
<!--   lapply(data.per.country.spec, function(x) -->
<!--   x%>% -->
<!--     filter(!is.na(Date_Found))%>% -->
<!--     filter(!(as.Date(Date_Received) >= as.Date(Date_Found)))%>% -->
<!--     dplyr::select(Country,Specimen_code)%>% -->
<!--     distinct(Country, Specimen_code)) -->


<!-- # if there are rows with wrong latitude -->

<!-- if(nrow(do.call(rbind, spec.received.earlier.than.found.date.per.country))>0){   -->

<!-- spec.received.earlier.than.found.date.per.country=do.call( -->
<!--   rbind, spec.received.earlier.than.found.date.per.country)%>% -->
<!--   dplyr::select(Country, Specimen_code) -->



<!-- # spit the data by country again now including the data of country based on the project tag -->
<!-- # for those rows wo country -->
<!-- spec.received.earlier.than.found.date.per.country= -->
<!-- lapply(sort(unique(spec.received.earlier.than.found.date.per.country$Country)), function(x)  -->
<!--   spec.received.earlier.than.found.date.per.country%>%filter(Country==x)%>% -->
<!--   dplyr::select(Country, Specimen_code)%>% -->
<!--   distinct(Country, Specimen_code)) -->

<!-- # name the list -->
<!-- names(spec.received.earlier.than.found.date.per.country)=sapply( -->
<!--   spec.received.earlier.than.found.date.per.country, function(x) unique(x$Country)) -->

<!-- # order by specimen code -->
<!-- spec.received.earlier.than.found.date.per.country= -->
<!--   lapply(spec.received.earlier.than.found.date.per.country, function(x) -->
<!--   x[order(x[,"Specimen_code"]), ]) -->

<!-- # move to da dataset with the event codes in a single row -->
<!-- spec.received.earlier.than.found.date.per.country.df= -->
<!--   lapply(spec.received.earlier.than.found.date.per.country, function(x) -->
<!--   data.frame(Specimen_code=paste(unique(x$Specimen_code), collapse = " "))) -->


<!--   spec.received.earlier.than.found.date.per.country.df=data.frame( -->
<!--     Country=names(spec.received.earlier.than.found.date.per.country.df),  -->
<!--     Specimen_code=unlist(spec.received.earlier.than.found.date.per.country.df, use.names = F)) -->

<!--    spec.received.earlier.than.found.date.per.country.df= -->
<!--      spec.received.earlier.than.found.date.per.country.df[ -->
<!--        spec.received.earlier.than.found.date.per.country.df$Specimen_code!="",] -->

<!--    #delete rownames -->
<!--   rownames(spec.received.earlier.than.found.date.per.country.df)=NULL  -->

<!--   # subset to specific country -->
<!-- spec.received.earlier.than.found.date.per.country.df= -->
<!--   spec.received.earlier.than.found.date.per.country.df%>%filter(Country==params$country.of.interest) -->

<!-- if(nrow(spec.received.earlier.than.found.date.per.country.df)>0){ -->


<!--   print("No, the data show that some specimens were received before they were found. These are the specimens that were found before they were received") -->

<!--   kableExtra::kbl(spec.received.earlier.than.found.date.per.country.df,  -->
<!--                   caption = "Specimens with inconsistency between the the date they were received and the date they were found") %>%    kableExtra::kable_paper(full_width = F) %>% -->
<!--     kableExtra::column_spec(1, bold = T, border_right = T) %>% -->
<!--     kableExtra::column_spec(2,  border_right = T, width = "30em") -->
<!-- }} -->

<!-- if(!exists("spec.received.earlier.than.found.date.per.country.df") | -->
<!--     exists("spec.received.earlier.than.found.date.per.country.df") &&  -->
<!--    nrow(spec.received.earlier.than.found.date.per.country.df)==0){   -->

<!--   spec.received.earlier.than.found.date.per.country=list(data.frame(Country="", Specimen_code="")) -->

<!--   rownames(spec.received.earlier.than.found.date.per.country[[1]])<-NULL -->


<!--   print("Yes, all specimens were received after they were found")} -->

<!-- ``` -->
#
## SPECIMEN SPECIES PROVIDED
#
#
#### Do all specimens have a species assigned?
#
#
```{r specimen species, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.species.not.reported=

dat$spec%>%
    filter(is.na(specimen_common_name)) %>% 
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.species.not.reported)>0){  

spec.species.not.reported.df=
  spec.species.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens do not have the species. These are the Specimen codes that do not have the species reported")
  
  kableExtra::kbl(spec.species.not.reported.df, 
                  caption = "Specimens species not provided")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have species reported")}
  

```
#
## SPECIMENS WITH FOUND BY
#
#
#### Do all specimens have the person that found them?
#
#
```{r specimen found by, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.found.by.not.reported=

dat$spec%>%
    filter(is.na(found_by)) %>% 
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.found.by.not.reported)>0){  

spec.found.by.not.reported.df=
  spec.found.by.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens do not have who found them. These are the Specimen codes that do not have the 'found by' field reported")
  
  kableExtra::kbl(spec.found.by.not.reported.df, 
                  caption = "Specimens that is unknown how they were found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)
}else{#}


  print("Yes, all specimens have the found by item reported")}
  

```
#
## SPECIMENS WITH AGE PROVIDED
#
#
#### Do all specimens have their age provided?
#
#
```{r specimen age, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.age.not.reported=

dat$spec%>%
    filter(is.na(age_category)) %>% 
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.age.not.reported)>0){  

spec.age.not.reported.df=
  spec.age.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens do not have the age category. These are the Specimen codes that do not have the age reported")
  
  kableExtra::kbl(spec.age.not.reported.df, 
                  caption = "Specimens without age reported")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have the age reported")}
  

```
#
## SEX PROVIDED
#
#
#### Do all specimens have their sex provided?
#
#
```{r specimen sex, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.sex.not.reported=

dat$spec%>%
    filter(is.na(sex)) %>% 
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.sex.not.reported)>0){  

spec.sex.not.reported.df=
  spec.sex.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens do not have the sex reported. These are the Specimen codes that do not have the sex reported")
  
  kableExtra::kbl(spec.sex.not.reported.df, 
                  caption = "Specimens without the sex reported")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have the sex reported")}
  

```
#
## CONDITION PROVIDED
#
#
#### Do all specimens have their condition provided?
#
#
```{r specimen condition, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.condition.not.reported=

dat$spec%>%
    filter(is.na(condition)) %>% 
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.condition.not.reported)>0){  

spec.condition.not.reported.df=
  spec.condition.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens do not have the condition reported. These are the Specimen codes that do not have the condition reported")
  
  kableExtra::kbl(spec.condition.not.reported.df, 
                  caption = "Specimens without the condition reported")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have the found by item reported")}
  

```
#
## CAPTIVITY CATEGORY PROVIDED
#
#
#### Do all specimens have their captivity category provided?
#
#
```{r specimen captivity category, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.captivity.category.not.reported=

dat$spec%>%
    filter(is.na(captivity_category)) %>% 
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.captivity.category.not.reported)>0){  

spec.captivity.category.not.reported.df=
  spec.captivity.category.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens do not have the captivity category reported. These are the Specimen codes that do not have the captivity category reported")
  
  kableExtra::kbl(spec.captivity.category.not.reported.df, 
                  caption = "Specimens without the captivity category reported")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have the captivity category reported")}
  

```
#
## FINAL CONDITION PROVIDED
#
#
#### Do all specimens have their final condition provided?
#
#
```{r specimen final condition, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.final.condition.not.reported=

dat$spec%>%
    filter(is.na(final_condition)) %>% 
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.final.condition.not.reported)>0){  

spec.final.condition.not.reported.df=
  spec.final.condition.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens do not have the final condition reported. These are the Specimen codes that do not have the final condition reported")
  
  kableExtra::kbl(spec.final.condition.not.reported.df, 
                  caption = "Specimens without the final condition reported")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have the final condition reported")}
  

```
#
## CLINICAL SIGNS PROVIDED (FOR NON-HEALTHY INDIVIDUALS)
#
#
#### Do all specimens have their clinical signs provided?
#
#
```{r specimen clinical signs, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.no.clinical.signs.reported=

dat$spec%>%
    filter(dat$spec$condition!="Found Live Healthy" & dat$spec$final_condition!="Alive Healthy") %>% 
    filter(is.na(clinical_signs)) %>% 
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.no.clinical.signs.reported)>0){  

spec.no.clinical.signs.reported.df=
  spec.no.clinical.signs.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some non-healthy specimens do not have clinical signs reported. These are the Specimen codes that do not have clinical signs reported")
  
  kableExtra::kbl(spec.no.clinical.signs.reported.df, 
                  caption = "Specimens without clinincal signs reported")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have the final condition reported")}
  

```
#
## NECROPSY
#
#
#### Were necropsies conducted since the event date?
#
#
```{r necropsy after the event date, echo=FALSE, warning=FALSE, eval=T, cache=F, message =FALSE}

spec.date.necropsy.earlier.than.event.date=
  dat$spec %>% 
    filter(!is.na(necropsy_date) & !is.na(event_date))%>%
    filter(!(as.Date(necropsy_date) >= as.Date(event_date)))%>%
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.date.necropsy.earlier.than.event.date)>0){  

spec.date.necropsy.earlier.than.event.date.df=
  spec.date.necropsy.earlier.than.event.date%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens were necropsied before the event date. These are the Specimen codes that were necropsied before the event date")
  
  kableExtra::kbl(spec.date.necropsy.earlier.than.event.date.df, 
                  caption = "Specimens necropsied before the event date")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens were necropsied after the event date")}
  

```
#
#### Were necropsies conducted since the specimen was found?
#
#
```{r necropsy after specimen found, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.date.necropsy.earlier.than.date.found=
   dat$spec %>% 
    filter(!is.na(necropsy_date) & !is.na(date_found))%>%
    filter(!(as.Date(necropsy_date) >= as.Date(date_found)))%>%
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.date.necropsy.earlier.than.date.found)>0){  

spec.date.necropsy.earlier.than.date.found.df=
  spec.date.necropsy.earlier.than.date.found%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens were necropsied before the specimen was found. These are the Specimen codes that were necropsied before the specimen was found")
  
  kableExtra::kbl(spec.date.necropsy.earlier.than.date.found.df, 
                  caption = "Specimens necropsied before they were found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens were necropsied after they were found")}

```
#
#### Is the "necropsy level" reported in WHIP? 
#
#
<!-- for those specimens without necropsy, the level is "No necropsy" -->

```{r specimen necropsy level, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.necropsy.level.not.reported=
   dat$spec %>% 
    # filter(!is.na(necropsy_date))%>%
    filter(is.na(necropsy_level))%>%
    dplyr::select(country, event_code, specimen_code)%>%
    distinct()


if(nrow(spec.necropsy.level.not.reported)>0){  

spec.necropsy.level.not.reported.df=
  spec.necropsy.level.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens do not have the necropsy level reported. These are the Specimen codes that do not have the necropsy level reported")
  
  kableExtra::kbl(spec.necropsy.level.not.reported.df, 
                  caption = "Specimens without necropsy level reported")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have the necropsy level reported")}


```
<!-- # -->
<!-- #### Carcass condition provided -->
<!-- # -->
<!-- # -->
<!-- ```{r specimen carcass condition provided, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE} -->

<!-- spec.carcass.condition.not.reported= -->

<!-- dat$spec%>% -->
<!--     filter(!is.na(necropy_level) & necropy_level!="No Necropsy") %>%  -->
<!--     filter(is.na(carcass_condition)) %>%  -->
<!--     dplyr::select(country, event_code, specimen_code)%>% -->
<!--     distinct() -->


<!-- if(nrow(spec.carcass.condition.not.reported)>0){   -->

<!-- spec.carcass.condition.not.reported.df= -->
<!--   spec.carcass.condition.not.reported%>% -->
<!--   group_by(country, event_code) %>% -->
<!--   dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>%  -->
<!--   arrange(country)   -->

<!--   print("No, the data show that some necropsied specimens do not have the carcass condition score. These are the Specimen codes that do not have the carcass condition") -->

<!--   kableExtra::kbl(spec.carcass.condition.not.reported.df,  -->
<!--                   caption = "Necropsied Specimens without carcass condition score")%>% -->
<!--      kableExtra::kable_paper(full_width = F) %>% -->
<!--     kableExtra::column_spec(1, bold = T, border_right = T) %>% -->
<!--     kableExtra::column_spec(2, bold = T, border_right = T) %>% -->
<!--     kableExtra::column_spec(3, width = "30em", border_right = T) -->
<!-- }else{#} -->


<!--   print("Yes, all necropsied specimens have the carcass condition score reported")} -->


<!-- ``` -->
<!-- # -->
<!-- #### Carcass field storage provided -->
<!-- # -->
<!-- # -->
<!-- ```{r specimen carcass field storage provided, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE} -->

<!-- spec.carcass.field.sotrage.reported= -->

<!-- dat$spec%>% -->
<!--     filter(!is.na(necropy_level) & necropy_level!="No Necropsy") %>% -->
<!--     filter(is.na(field_storage)) %>% -->
<!--     dplyr::select(country, event_code, specimen_code)%>% -->
<!--     distinct() -->


<!-- if(nrow(spec.carcass.condition.not.reported)>0){ -->

<!-- spec.carcass.condition.not.reported.df= -->
<!--   spec.carcass.condition.not.reported%>% -->
<!--   group_by(country, event_code) %>% -->
<!--   dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% -->
<!--   arrange(country) -->

<!--   print("No, the data show that some necropsied specimens do not have the carcass condition score. These are the Specimen codes that do not have the carcass condition") -->

<!--   kableExtra::kbl(spec.carcass.condition.not.reported.df, -->
<!--                   caption = "Necropsied Specimens without carcass condition score")%>% -->
<!--      kableExtra::kable_paper(full_width = F) %>% -->
<!--     kableExtra::column_spec(1, bold = T, border_right = T) %>% -->
<!--     kableExtra::column_spec(2, bold = T, border_right = T) %>% -->
<!--     kableExtra::column_spec(3, width = "30em", border_right = T) -->
<!-- }else{#} -->


<!--   print("Yes, all necropsied specimens have the carcass condition score reported")} -->


<!-- ``` -->

#
#### Do all necropsied specimens have their primary necropsy or secondary necropsy findings provided?
#
#
```{r specimen necropsy level but no necropsy report, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

#text versions in the "Primary necropsy tab"

# primary.necropsy.v1=c("#Add observations below on each row, after the \";\" Add \"NA\" if not assessed, or \"NAF\" if no abnormal finding \r\n Body condition score \r\n External signs on carcass; \r\n Wounds/Scars; \r\n Skin/Hair Coat/Nails; \r\n External parasites; \r\n Subcutaneous fat (very fat/normal/no fat); \r\n Muscle mass (normal/thin/emaciated); \r\n Nostrils; \r\n Ears; \r\n Eyes; \r\n Mouth; \r\n Anus/perineum; \r\n Musculoskeletal System; \r\n Body Cavities; \r\n Peri-organ fat (very fat/normal/no fat); \r\n Circulatory System; \r\n Respiratory System; \r\n Hemolymphatic System; \r\n Gastrointestinal system; \r\n Urinary System; \r\n Reproductive System; \r\n Nervous System; \r\n Conclusion;")
# 
# primary.necropsy.v2=c("#Add observations below on each row, after the \";\" Add \"NA\" if not assessed, or \"NAF\" if no abnormal finding \r\n Body condition score; \r\n External signs on carcass; \r\n Wounds/Scars; \r\n Skin/Hair Coat/Nails; \r\n External parasites; \r\n Subcutaneous fat (very fat/normal/no fat); \r\n Muscle mass (normal/thin/emaciated); \r\n Nostrils; \r\n Ears; \r\n Eyes; \r\n Mouth; \r\n Anus/perineum; \r\n Musculoskeletal System; \r\n Body Cavities; \r\n Peri-organ fat (very fat/normal/no fat); \r\n Circulatory System; \r\n Respiratory System; \r\n Hemolymphatic System; \r\n Gastrointestinal system; \r\n Urinary System; \r\n Reproductive System; \r\n Nervous System; \r\n Conclusion;")
# 
# primary.necropsy.v3=c("#Add observations below on each row, after the \";\" Add \"NA\" if not assessed, or \"NAF\" if no abnormal finding  Body condition score;  External signs on carcass;  Wounds/Scars;  Skin/Hair Coat/Nails;  External parasites;  Subcutaneous fat (very fat/normal/no fat);  Muscle mass (normal/thin/emaciated);  Nostrils;  Ears;  Eyes;  Mouth;  Anus/perineum;  Musculoskeletal System;  Body Cavities;  Peri-organ fat (very fat/normal/no fat);  Circulatory System;  Respiratory System;  Hemolymphatic System;  Gastrointestinal system;  Urinary System;  Reproductive System;  Nervous System;  Conclusion;")
# 
# primary.necropsy.v4=c("#Describe necropsy findings for each item. Make sure to type the findings between the \":\" and the \";\" (basically replace \"your findings\" text with your own data) in each system. It is key to: i) Leave the \";\" at the end of each section as the last character without a preceding space ii) Do not use \";\" or \":\" when writing the findings iii) Replace \"your findings\" with \"NA\" if the system is not assessed or \"NAF\" if no abnormal finding iv) Do not delete the instructions including this line and start after this line//  External Signs On Carcass: your findings;  Nutritional Condition (Emaciated/Thin/Normal/Overweight/Obese): your findings;  Eyes: your findings;  Ears: your findings;  Nostrils: your findings;  Mouth: your findings;  Skin/Hair Coat/Nails: your findings;   Wounds/Scars: your findings;   External Parasites: your findings;  Anus/Perineum/Cloaca: your findings;  Subcutaneous Fat (very fat/normal/no fat): your findings;  Muscle Mass: your findings;  Musculoskeletal System: your findings;  Body Cavities: your findings;  Circulatory/Cardiovascular System (heart, valves, vessels): your findings;  Respiratory System (larynx, trachea, bronchi, lungs): your findings;  Gastrointestinal System (esophagus, stomach, intestine, feces, pancreas, liver, gallbladder): your findings;  Urinary System (kidneys, ureter, urinary bladder, urethra): your findings;  Reproductive System (ovaries, uterus, testes, epididymis, prostate, presence of fetus): your findings;  Lymphatic System (spleen, lymph nodes): your findings;  Endocrine System (thyroid/parathyroid, adrenal, pituitary): your findings;  Nervous System (brain, spinal cord, peripheral nerves): your findings;  Conclusion: your findings;")
# 
# primary.necropsy.v5=c("#Describe necropsy findings for each item. Make sure to type the findings between the \":\" and the \";\" (basically replace \"your findings\" text with your own data) in each system. It is key to: i) Leave the \";\" at the end of each section as the last character without a preceding space ii) Do not use \";\" or \":\" when writing the findings iii) Replace \"your findings\" with \"NA\" if the system is not assessed or \"NAF\" if no abnormal finding iv) Do not delete the instructions including this line and start after this line// \r\n External Signs On Carcass: your findings; \r\n Nutritional Condition (Emaciated/Thin/Normal/Overweight/Obese): your findings; \r\n Eyes: your findings; \r\n Ears: your findings; \r\n Nostrils: your findings; \r\n Mouth: your findings; \r\n Skin/Hair Coat/Nails: your findings; \r\n Wounds/Scars: your findings; \r\n External Parasites: your findings; \r\n Anus/Perineum/Cloaca: your findings; \r\n Subcutaneous Fat (very fat/normal/no fat): your findings; \r\n Muscle Mass: your findings; \r\n Musculoskeletal System: your findings; \r\n Body Cavities: your findings; \r\n Circulatory/Cardiovascular System (heart, valves, vessels): your findings; \r\n Respiratory System (larynx, trachea, bronchi, lungs): your findings; \r\n Gastrointestinal System (esophagus, stomach, intestine, feces, pancreas, liver, gallbladder): your findings; \r\n Urinary System (kidneys, ureter, urinary bladder, urethra): your findings; \r\n Reproductive System (ovaries, uterus, testes, epididymis, prostate, presence of fetus): your findings; \r\n Lymphatic System (spleen, lymph nodes): your findings; \r\n Endocrine System (thyroid/parathyroid, adrenal, pituitary): your findings; \r\n Nervous System (brain, spinal cord, peripheral nerves): your findings; \r\n Conclusion: your findings;")


primary.necropsy.v1="Original Necropsy Text:  #Describe necropsy findings for each item. Make sure to type the findings between the \":\" and the \";\" (basically replace \"your findings\" text with your own data) in each system. It is key to: i) Leave the \";\" at the end of each section as the last character without a preceding space ii) Do not use \";\" or \":\" when writing the findings iii) Replace \"your findings\" with \"NA\" if the system is not assessed or \"NAF\" if no abnormal finding iv) Do not delete the instructions including this line and start after this line// \n External Signs On Carcass: your findings; \n Nutritional Condition (Emaciated/Thin/Normal/Overweight/Obese): your findings; \n Eyes: your findings; \n Ears: your findings; \n Nostrils: your findings; \n Mouth: your findings; \n Skin/Hair Coat/Nails: your findings; \n Wounds/Scars: your findings; \n External Parasites: your findings; \n Anus/Perineum/Cloaca: your findings; \n Subcutaneous Fat (very fat/normal/no fat): your findings; \n Muscle Mass: your findings; \n Musculoskeletal System: your findings; \n Body Cavities: your findings; \n Circulatory/Cardiovascular System (heart, valves, vessels): your findings; \n Respiratory System (larynx, trachea, bronchi, lungs): your findings; \n Gastrointestinal System (esophagus, stomach, intestine, feces, pancreas, liver, gallbladder): your findings; \n Urinary System (kidneys, ureter, urinary bladder, urethra): your findings; \n Reproductive System (ovaries, uterus, testes, epididymis, prostate, presence of fetus): your findings; \n Lymphatic System (spleen, lymph nodes): your findings; \n Endocrine System (thyroid/parathyroid, adrenal, pituitary): your findings; \n Nervous System (brain, spinal cord, peripheral nerves): your findings; \n Conclusion: your findings;"


# all necropsy columns are NA but they have necropsy as reported ...

spec.necropsy.but.no.finding.reported=

# dat$spec %>% 
#   filter(!is.na(necropsy_level) & !(necropsy_level%in%c("No Necropsy", "Pending"))) %>% 
#   filter(necropsy==primary.necropsy.v1 | 
#            necropsy==primary.necropsy.v2 |
#            necropsy==primary.necropsy.v3 |
#            necropsy==primary.necropsy.v4 |
#            necropsy==primary.necropsy.v5) %>% 
#   dplyr::select(country, event_code, specimen_code)%>%
#   distinct()

dat$spec %>% 
   filter(!is.na(necropsy_level) & !(necropsy_level%in%c("No Necropsy", "Pending"))) %>% 
  filter(!if_all(contains("primary_necropsy"), is.na) &
           necropsy_primary_necropsy_conclusion==primary.necropsy.v1) %>% 
  # select(necropsy_level, contains("primary_necropsy")) %>% 
  dplyr::select(country, event_code, specimen_code) %>%
  distinct()



if(nrow(spec.necropsy.but.no.finding.reported)>0){  

spec.necropsy.but.no.finding.reported.df=
  spec.necropsy.but.no.finding.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens may have been necropsied but the necropsy findings have not been provided. These are the necropsied Specimen codes that do not have the necropsy findings provided")
  
  kableExtra::kbl(spec.necropsy.but.no.finding.reported.df, 
                  caption = "Necropsied Specimens without necropsy findings provided")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens have the necropsied specimens have the necropsy findings provided")}

```
#
#### Are there all necropsies not pending?
#
#
```{r specimens with pending necropsy, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.pending.necropsy=
dat$spec %>% 
  filter(necropsy_level=="Pending") %>% 
  dplyr::select(country, event_code, specimen_code)%>%
  distinct()

if(nrow(spec.pending.necropsy)>0){  

spec.pending.necropsy.df=
  spec.pending.necropsy%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens have their necropsy pending and the information may need to be updated. These are the Specimen codes with pending necropsy")
  
  kableExtra::kbl(spec.pending.necropsy.df, 
                  caption = "Specimens with pending necropsy")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all the necropsies are not pending")}
```
#
## SUMMARY ISSUES AT THE SPECIMENS LEVEL
#
"Yes" cells indicate problems for the item specified in the corresponding column name.

```{r issues specimen level, echo=FALSE, warning=FALSE, eval=T, cache=F}

#data frame event codes without fundgin project tag

specimens.funding.source.project.tag.not.provided$No_funding_project_tag="Yes"

#data frame event codes without surveillance project tag

specimens.surveillance.project.tag.not.provided$No_surveillance_project_tag="Yes"

#data frame specimens codes without surveillance or outbreak unit

spec.surveillance.unit.not.provided$No_surveillance_outbreak_unit="Yes"

#data frame specimens codes without animal id

specimen.codes.with.animal.ids.as.na$No_animal_id="Yes"

#data frame animal id in more than one specimen

specimen.codes.with.more.than.one.animal.ids$Repeated_animal_id="Yes"

#data frame specimens codes without observed date

spec.codes.date.found.provided$No_found_date="Yes"

#data frame specimens codes found earlier than event date

spec.codes.date.found.earlier.date$Found_before_event_date="Yes"


spec.species.not.reported$No_species="Yes"


spec.found.by.not.reported$No_found_by="Yes"


spec.age.not.reported$No_age="Yes"


spec.sex.not.reported$No_sex="Yes"


spec.condition.not.reported$No_condition="Yes"


#data frame observation codes without captivity category

spec.captivity.category.not.reported$No_captivity_cat="Yes"


spec.final.condition.not.reported$No_final_condition="Yes"


#data frame observation codes without clinical signs

spec.no.clinical.signs.reported$No_clinical_signs="Yes"


spec.date.necropsy.earlier.than.event.date$Necroopsy_before_event="Yes"

spec.date.necropsy.earlier.than.date.found$Necropsy_before_found="Yes"

spec.necropsy.level.not.reported$Necropsy_level_not_reported="Yes"

spec.necropsy.but.no.finding.reported$Necropsy_no_finding="Yes"

spec.pending.necropsy$Necropsy_pending="Yes"


# data showing the issues per event code per country
specimen.codes.with.issues=full_join(specimens.funding.source.project.tag.not.provided, 
                                  specimens.surveillance.project.tag.not.provided,
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.surveillance.unit.not.provided,
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  specimen.codes.with.animal.ids.as.na,
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  specimen.codes.with.more.than.one.animal.ids,
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.codes.date.found.provided, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.codes.date.found.earlier.date, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.species.not.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.found.by.not.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.age.not.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.sex.not.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.condition.not.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.captivity.category.not.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.final.condition.not.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.no.clinical.signs.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.date.necropsy.earlier.than.event.date, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.date.necropsy.earlier.than.date.found, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.necropsy.level.not.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.necropsy.but.no.finding.reported, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=full_join(specimen.codes.with.issues,
                                  spec.pending.necropsy, 
                                  by=c("country", "event_code", "specimen_code"))

specimen.codes.with.issues=specimen.codes.with.issues %>% arrange(country, event_code, specimen_code)


if(nrow(specimen.codes.with.issues)>0){
  
      # removing columns were everything is NA
specimen.codes.with.issues=specimen.codes.with.issues%>%dplyr::select_if(~ !all(is.na(.)))
  
  
if(any(is.na(specimen.codes.with.issues))){specimen.codes.with.issues[is.na(specimen.codes.with.issues)]="No"}
  
print("Please scroll down the table below to see the complete dataset")  
  
 kableExtra::kbl(specimen.codes.with.issues,
                  caption = "specimens codes with problems") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(c(2:ncol(specimen.codes.with.issues)), border_right = T, width = "8em")%>%

    # kableExtra::collapse_rows(1)
    scroll_box(width = "100%", height = "600px")

}else{
  
  print("No specimen codes present problems")}  

```
#
# SPECIMEN SAMPLES
#
#
## SAMPLING DATE SINCE THE EVENT DATE
#
#### Were all the samples collected since the event date?
#
#
```{r sample dates, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


sample.date.collected.earlier.than.event.date=
  dat$spec %>% 
    filter(!is.na(date_sampled) & !is.na(event_date))%>%
    filter(!(as.Date(date_sampled) >= as.Date(event_date)))%>%
    dplyr::select(country, event_code, specimen_code, sample_id)%>%
    distinct()


if(nrow(sample.date.collected.earlier.than.event.date)>0){  

sample.date.collected.earlier.than.event.date.df=
  sample.date.collected.earlier.than.event.date%>%
  group_by(country, event_code, specimen_code) %>%
  dplyr::summarise(sample_ids = paste(sample_id, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some samples were collected before the event date. These are the samples that were collected before the event date")
  
  kableExtra::kbl(sample.date.collected.earlier.than.event.date.df, 
                  caption = "Samples collected before the event date")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all samples were collected since the event date")}

```
#
## SAMPLING SINCE THE SOURCE SPECIMEN WAS FOUND
#
#
#### Were the samples collected since the date the source specimen was found?
#
#
```{r sample dates 2, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}

sample.date.collected.earlier.than.specimen.found=
  dat$spec %>% 
    filter(!is.na(date_sampled) & !is.na(date_found))%>%
    filter(!(as.Date(date_sampled) >= as.Date(date_found)))%>%
    dplyr::select(country, event_code, specimen_code, sample_id)%>%
    distinct()


if(nrow(sample.date.collected.earlier.than.specimen.found)>0){  

sample.date.collected.earlier.than.specimen.found.df=
  sample.date.collected.earlier.than.specimen.found%>%
  group_by(country, event_code, specimen_code) %>%
  dplyr::summarise(sample_ids = paste(sample_id, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some samples were collected before the specimen was found. These are the samples that were collected before the specimen was found.")
  
  kableExtra::kbl(sample.date.collected.earlier.than.specimen.found.df, 
                  caption = "Samples collected before the specimen source was found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all samples were collected since the specimen was found")}



```
#
## SAMPLE IDS PROVIDED
#
#
#### Are all the sample IDs provided?
#
#
```{r sample id provided, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.sample.ids.provided=
dat$spec %>% 
  filter(is.na(sample_id) & meta_has_sample_inventory=="Yes") %>% 
  dplyr::select(country, event_code, specimen_code)%>%
  distinct()

if(nrow(spec.sample.ids.provided)>0){  

spec.sample.ids.provided.df=
  spec.sample.ids.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some specimens have samples but their sample ids are not provided. These are the Specimen codes with samples without ids")
  
  kableExtra::kbl(spec.sample.ids.provided.df, 
                  caption = "Specimens have samples without ids")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    # kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all the samples have sample id")}


```
#
## SAMPLE TYPES PROVIDED
#
#
#### Are all sample types provided?
#
#
```{r sample type provided, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

spec.sample.types.provided=
dat$spec %>% 
  filter(is.na(sample_type) & !is.na(sample_id) & meta_has_sample_inventory=="Yes") %>% 
  dplyr::select(country, event_code, specimen_code, sample_id)%>%
  distinct()

if(nrow(spec.sample.types.provided)>0){  

spec.sample.types.provided.df=
  spec.sample.types.provided%>%
  group_by(country, event_code, specimen_code) %>%
  dplyr::summarise(sample_ids = paste(sample_id, collapse = ", ")) %>% 
 arrange(country)  
  
  print("No, the data show that some specimens have samples but their sample types are not provided. These are the Specimen codes with sample types not provided")
  
  kableExtra::kbl(spec.sample.types.provided.df, 
                  caption = "Specimens samples with of unknown type")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    # kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all sample types are provided")}


```
<!-- # -->
<!-- # -->
<!-- ##### Do the sample IDs follow the standardized labeling structure? -->
<!-- # -->
```{r sample ids 2, echo=FALSE, warning=FALSE, eval=F, cache=FALSE}

country.abbreviations=c("KH", "LA", "VN")

project.abbreviations=c("W")

taxa=list(A="Amphibian", B="Bat", C="Carnivore",
          E="Elephant", F="Fish", G="Pangolin",
          L="Reptile", M="Marine mammal", P="Primate",
          R="Rodent", S="Swine", U="Ungulate",
          W="Wild bird", X="Environmental")

project.country.abbreviations=paste0(rep(project.abbreviations,
                                         each = length(country.abbreviations))
                                     , country.abbreviations, "-")


sample.type=c("OS", "RS", "NS", "US", "FF", "DF", "UR", "CC", "GC", "VM",
              "FL", "JF", "CF", "ML", "BW","BP", "BS", "BC", "AG", "BM", 
              "BN", "BR", "ES", "EY", "GB", "FR", "FS", "HT", "HR", "IL",
              "IS", "KD", "LN", "LU", "LV", "MG", "MT", "MU", "NV", "OV", "PN",
              "SC", "SK", "SP", "ST", "TG", "TO", "TN", "TR", "TS", "UB", "UM",
              "UT", "DM", "SM", "FM", "PL", "PM", "PT", "PF", "PR", "PP", "PZ",
              "FP", "PO", "SD", "SL", "WA")

medium = c("A", "B", "F", "P", "R", "T", "U", "V")

# where sample ID are provided
spec.sample.id.provided=spec[!is.na(spec$Sample_ID),]

# first part of sample ids when they are not NA
first.part.sample.ids.project.country.hyphen= # one letter for project, 2 letters for country, and hyphen
  substr(spec.sample.id.provided$Sample_ID, 1,5) 

#in the second part of the label
second.part.sample.ids.taxa.numeric=  # one letter for taxa, 3 numbers
  sapply(strsplit(spec.sample.id.provided$Sample_ID, "-"), function(x) x[2])


#in the third part of the label

third.part.sample.ids.taxa.numeric=  # two letter for sample type, 
  sapply(strsplit(spec.sample.id.provided$Sample_ID, "-"), function(x) x[3])

# in the fourth part of the label

fourth.part.sample.ids.taxa.numeric=  # one letter for taxa, 3 numbers
  sapply(strsplit(spec.sample.id.provided$Sample_ID, "-"), function(x) x[4])




  wrong.sample.id.first.part=
    
    spec.sample.id.provided$Sample_ID[
      
      !(substring(first.part.sample.ids.project.country.hyphen, 1,1)%in%project.abbreviations) | # first piece does have a valid project letter?
        
        !(substring(first.part.sample.ids.project.country.hyphen, 2,3)%in%country.abbreviations) | # second piece has valid country abbreviations?
        
        substring(first.part.sample.ids.project.country.hyphen, 4,4)!="-"]
  
  
  
  
  wrong.sample.id.second.part=
    
    spec.sample.id.provided$Sample_ID[
      
      !(substring(second.part.sample.ids.taxa.numeric, 1,1)%in%names(taxa)) | # second piece does have a valid taxa letter?
        
        is.na(as.numeric(substring(second.part.sample.ids.taxa.numeric, 2,4)))]
  
  
  
  
  wrong.sample.id.third.part=
    
    spec.sample.id.provided$Sample_ID[ #third piece does ahave a valid sample type abb
    
    !(substring(third.part.sample.ids.taxa.numeric, 1,2)%in%sample.type) & 
    
    nchar(third.part.sample.ids.taxa.numeric)!=2] # then there is nothing afterwards
    
  
    
  
  wrong.sample.id.fourth.part=spec.sample.id.provided$Sample_ID[ #fourth piece does a have a valid medium type
    
    !(substring(fourth.part.sample.ids.taxa.numeric, 1)%in%medium)]
    
  
  # wrong sample ids
  wrong.sample.id=sort(unique(c(wrong.sample.id.first.part, 
                                wrong.sample.id.second.part, 
                                wrong.sample.id.third.part, 
                                wrong.sample.id.fourth.part)))
  
  
  
  specimen.codes.with.wrong.sample.ids.per.country=
  lapply(data.per.country.spec, function(x)
  x%>%
  filter(!is.na(Sample_ID) & Sample_ID%in%wrong.sample.id))

  
  if(nrow(do.call(rbind, specimen.codes.with.wrong.sample.ids.per.country))>0){

  specimen.codes.with.wrong.sample.ids.per.country=
  do.call(
  rbind, specimen.codes.with.wrong.sample.ids.per.country)%>%
  dplyr::select(Country, Event_Code, Specimen_code,  Sample_ID, Sample_type, Medium_Type, Date_Sampled)

# spit the data by country again now including the data of country based on the project tag
# for those rows wo country
specimen.codes.with.wrong.sample.ids.per.country=
lapply(sort(unique(specimen.codes.with.wrong.sample.ids.per.country$Country)), function(x) 
  specimen.codes.with.wrong.sample.ids.per.country%>%filter(Country==x)%>%
  dplyr::select(Country, Event_Code, Specimen_code, Sample_ID, Sample_type, Medium_Type, Date_Sampled)%>%
  distinct(Country, Event_Code, Specimen_code,  Sample_ID, Sample_type, Medium_Type, Date_Sampled))

# name the list
names(specimen.codes.with.wrong.sample.ids.per.country)=sapply(
  specimen.codes.with.wrong.sample.ids.per.country, function(x) unique(x$Country))
    

# move to da dataset with the event codes in a single row
specimen.codes.with.wrong.sample.ids.per.country.df=
do.call(rbind, specimen.codes.with.wrong.sample.ids.per.country)

#order by country and specimen code
specimen.codes.with.wrong.sample.ids.per.country.df=
  specimen.codes.with.wrong.sample.ids.per.country.df[order(
    specimen.codes.with.wrong.sample.ids.per.country.df$Country, 
    specimen.codes.with.wrong.sample.ids.per.country.df$Specimen_code),]

   #delete rownames
  rownames(specimen.codes.with.wrong.sample.ids.per.country.df)=NULL 

   # subset to specific country
specimen.codes.with.wrong.sample.ids.per.country.df=
specimen.codes.with.wrong.sample.ids.per.country.df%>%filter(Country==params$country.of.interest)

if(nrow(specimen.codes.with.wrong.sample.ids.per.country.df)>0){  
  
  
    print("No. Not all sample IDs provided follow the label format. These are the sample IDs with wrong format.
Please scroll the table below down and left-right to see the complete dataset if needed", appendLF = T)

    
  kableExtra::kbl(specimen.codes.with.wrong.sample.ids.per.country.df, 
                  caption = "Wrong sample IDs per country") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2:6, border_right = T, width = "15em")%>%
    # collapse_rows(columns = 2:3)%>%
    scroll_box(width = "100%", height = "600px")
    
}}

  if(!exists("specimen.codes.with.wrong.sample.ids.per.country.df") |
    exists("specimen.codes.with.wrong.sample.ids.per.country.df") && 
   nrow(specimen.codes.with.wrong.sample.ids.per.country.df)==0){  

  specimen.codes.with.wrong.sample.ids.per.country=list(
    data.frame(Country="", 
               Event_Code="", 
               Specimen_code="", 
               Sample_ID="", 
               Sample_type="",
               Medium_Type="",
               Date_Sampled=""))
   
  rownames(specimen.codes.with.wrong.sample.ids.per.country[[1]])<-NULL
  
  print("Yes, all sample IDs provided have the correct format")}


```
#
## SAMPLE IDS UNDER A SINGLE EVENT
#
#
#### Are sample IDs under a single event?
#
#
```{r sample ids under single event, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


spec.sample.ids.in.more.one.event=
  dat$spec %>% 
  filter(!is.na(sample_id))%>%
  distinct(event_code, sample_id) %>% 
  count(sample_id) %>% 
  filter(n>1)%>%
  pull(sample_id)

spec.sample.ids.in.more.one.event=
  dat$spec %>% 
  filter(sample_id %in% spec.sample.ids.in.more.one.event) %>% 
  dplyr::select(country, event_code, specimen_code, sample_id) %>% 
  distinct() %>% 
  arrange(sample_id)

if(nrow(spec.sample.ids.in.more.one.event)>0){  

spec.sample.ids.in.more.one.event.df=
  spec.sample.ids.in.more.one.event%>%
  group_by(country, sample_id) %>%
  dplyr::summarise(
    event_codes = paste(event_code, collapse = ", "), 
    specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some sample ids ahave been used in more than one event. These are the sample ids used in more than one event")
  
  kableExtra::kbl(spec.sample.ids.in.more.one.event.df, 
                  caption = "Sample ids used in more than one event")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all the sample ids are used in a single event")}


```
#
## SAMPLE IDS UNDER A SINGLE SPECIMEN
#
#
#### Are sample IDs under a single specimen?
#
#
```{r sample ids under single specimen, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}

spec.sample.ids.in.more.one.spec=
  dat$spec %>% 
  filter(!is.na(sample_id))%>%
  distinct(specimen_code, sample_id) %>% 
  count(sample_id) %>% 
  filter(n>1)%>%
  pull(sample_id)

spec.sample.ids.in.more.one.spec=
  dat$spec %>% 
  filter(sample_id %in% spec.sample.ids.in.more.one.spec) %>% 
  dplyr::select(country, event_code, specimen_code, sample_id) %>% 
  distinct() %>% 
  arrange(sample_id)

if(nrow(spec.sample.ids.in.more.one.spec)>0){  

spec.sample.ids.in.more.one.spec.df=
  spec.sample.ids.in.more.one.spec%>%
  group_by(country, sample_id) %>%
  dplyr::summarise(
    event_codes = paste(event_code, collapse = ", "), 
    specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some sample ids have been used in more than one specimen. These are the sample ids used in more than one specimen")
  
  kableExtra::kbl(spec.sample.ids.in.more.one.spec.df, 
                  caption = "Sample ids in more than one specimen")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    # kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all the sample ids are used in a single specimen")}


```
#
## SAMPLE QUANTITIES PROVIDED
#
#
#### Are the sample quantities provided?
#
#
```{r sample quantity provided, echo=FALSE, warning=FALSE, eval=T, cache=F}

sample.quantity.provided=
dat$spec %>% 
  filter(is.na(quantity) & !is.na(sample_id)) %>% 
  dplyr::select(country, event_code, specimen_code, sample_id, quantity) %>% 
  distinct()

if(nrow(sample.quantity.provided)>0){  

sample.quantity.provided.df=
  sample.quantity.provided %>% 
   group_by(country, event_code, specimen_code) %>%
  dplyr::summarise(sample_ids = paste(sample_id, collapse = ", "))%>% 
  arrange(country)  

  
  print("No. The data have samples without their quantities.These are the samples whose quantity is not provided." )
  
  kableExtra::kbl(sample.quantity.provided.df, 
                  caption = "Sample IDs without the quantity provided")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes. All sample quantities are provided")}
```
#
## SAMPLE QUANTITIES PROVIDED INFORMATIVE
#
#
#### Are the sample quantities provided informative?
#
#
```{r sample quantity, echo=FALSE, warning=FALSE, eval=T, cache=F}

# BAsed on the temp vector, find problematic quantities
# temp=
# dat$spec %>% filter(meta_has_sample_inventory=="Yes") %>% 
#   distinct(quantity) %>% pull()
sample.quantity.not.informative=
dat$spec %>% 
  filter(!is.na(quantity) & quantity %in% c("gram", "One oral", "1", "Whole blood in", "plain", "Skin in plain", "40PZ in 1.8ml of alcohol", "1FP")) %>% 
  dplyr::select(country, event_code, specimen_code, sample_id, quantity) %>% 
  distinct()

if(nrow(sample.quantity.not.informative)>0){  

sample.quantity.not.informative.df=
  sample.quantity.not.informative %>% 
   group_by(country, event_code, specimen_code) %>%
  dplyr::summarise(sample_ids = paste(sample_id, collapse = ", "))%>% 
  arrange(country)  

  
  print("No. The data have sample quantities that are not informative.These are the samples whose quantity is not informative." )
  
  kableExtra::kbl(sample.quantity.not.informative.df, 
                  caption = "Sample IDs that do not have an informative quantity")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes. All the sample quantities provided are informative.")}
```
#
## SAMPLES NOT USED IN TESTS (YET?) BUT MORE THAN ONCE PER SPECIMEN
#
#
#### Are all samples that have not used in tests (yet) unique per specimen?
there should be a single data point for these sample ids and no more 
#
#
```{r repeated samples without tests dates, echo=FALSE, warning=FALSE, eval=T, message=-FALSE}

#how can sample id be repeated within the same specimen

#at least two rows, none of them with disease test: always problematic because it means the sample id is repeated for different tissue and any of them has been used for a test

samples.no.test.but.repeated= dat$spec %>% 
  select(country, event_code, specimen_code, sample_id, disease) %>%
  filter(is.na(disease) & !is.na(sample_id)) %>% 
  count(country, event_code, specimen_code, sample_id) %>%
  filter(n>1) %>% 
  select(country, event_code, specimen_code, sample_id)

if(nrow(samples.no.test.but.repeated)>0){  

samples.no.test.but.repeated.df=
  samples.no.test.but.repeated %>% 
   group_by(country, event_code, specimen_code) %>%
  dplyr::summarise(sample_ids = paste(sample_id, collapse = ", "))%>% 
  arrange(country)  

  
  print("The data have sample ids that are repeated for a specific specimen but that have not been used for any tests. These sample ids are used in more than one sample and should have a '.number' after the id follwoing the guidelines here https://docs.google.com/document/d/1qdrUJKN234as7Xd5E6_7QewT6l5hQ940/edit. These are the sample ids not used for any test so far but repeated for a specimen." )
  
  kableExtra::kbl(samples.no.test.but.repeated.df, 
                  caption = "Specimen codes with repeated sample ids that have not been used in any test")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("None of the specimens have repeated samples that have not been used for any test")}
```
#
## SAMPLE ID WITH AND WITHOUT TEST UNDER A SINGLE SPECIMEN
#
#
#### Are sample IDs associated and not associated with tests?
There should be a single data point only for these sample id associated with a test and not more. The row with the sample id wo test should not exist 
#
```{r repeated samples with and without tests single specimen, echo=FALSE, warning=FALSE, eval=T, message = FALSE}

#at least two rows, one of them with disease test and the other not:  always problematic because the row without disease test should not be present: sample id is repeated for a sample not used in a test and for a sample that was used in at least one test.

temp=
dat$spec %>% 
  select(country, event_code, specimen_code, sample_id, disease) %>%
  filter(!is.na(sample_id)) %>% 
  nest(data=c(disease)) %>%
  filter(map_int(data, nrow)>1)   # filtering out groups whose data (disease) has a single row.
indexing.samples.diseases.and.not.diseases=
map_lgl(temp$data, function(x) any(is.na(x$disease)) & any(!is.na(x$disease)))

samples.with.test.and.wo.test=
  temp %>% 
  filter(indexing.samples.diseases.and.not.diseases) %>% 
  select(country, event_code, specimen_code, sample_id, data) 

if(nrow(samples.with.test.and.wo.test)>0){  

samples.with.test.and.wo.test.df=
  samples.with.test.and.wo.test %>% 
  group_by(country, event_code, specimen_code) %>%
  dplyr::summarise(
    sample_ids = paste(sample_id, collapse = ", "))%>% 
  arrange(country)  

  print("The data have specimens with sample ids that contain at least two tests and one of them does not have a specified disease. This means that the two rows are from independent samples and that the sample id is repeated for more than one sample." )
  
  kableExtra::kbl(samples.with.test.and.wo.test.df, 
                  caption = "Sample ids are repeated for at least two samples, some of them with a test and some without a test")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("None of the specimens have repeated samples ids that have and have not been used for a test")}


```
#
## SUMMARY ISSUES AT THE SPECIMENS SAMPLES LEVEL
#
"Yes" cells indicate problems for the item specified in the corresponding column name.

```{r issues specimen samples level, echo=FALSE, warning=FALSE, eval=T, cache=F}


sample.date.collected.earlier.than.event.date$Sampling_date_before_event="Yes"

sample.date.collected.earlier.than.specimen.found$Sampling_date_before_specimen_found="Yes"

spec.sample.ids.provided$No_sample_id_provided="Yes"

spec.sample.types.provided$No_sample_type="Yes"

spec.sample.ids.in.more.one.event$Sample_id_for_more_one_event="Yes"

spec.sample.ids.in.more.one.spec$Sample_id_more_one_spec="Yes"

sample.quantity.provided$Sample_quantity_missing="Yes"

sample.quantity.not.informative$Sample_quantity_not_informative="Yes"

samples.no.test.but.repeated$Repeated_sample="Yes"

samples.with.test.and.wo.test$Repeated_sample_2="Yes"

# data showing the issues per event code per country
specimen.sample.codes.with.issues=full_join(sample.date.collected.earlier.than.event.date, 
                                  sample.date.collected.earlier.than.specimen.found,
                                  by=c("country", "event_code", "specimen_code", "sample_id"))

specimen.sample.codes.with.issues=full_join(specimen.sample.codes.with.issues,
                                  spec.sample.ids.provided,
                                  by=c("country", "event_code", "specimen_code"))

specimen.sample.codes.with.issues=full_join(specimen.sample.codes.with.issues,
                                  spec.sample.types.provided,
                                  by=c("country", "event_code", "specimen_code", "sample_id"))

specimen.sample.codes.with.issues=full_join(specimen.sample.codes.with.issues,
                                  spec.sample.ids.in.more.one.event, 
                                  by=c("country", "event_code", "specimen_code", "sample_id"))

specimen.sample.codes.with.issues=full_join(specimen.sample.codes.with.issues,
                                  spec.sample.ids.in.more.one.spec, 
                                  by=c("country", "event_code", "specimen_code", "sample_id"))

specimen.sample.codes.with.issues=full_join(specimen.sample.codes.with.issues,
                                  sample.quantity.provided %>% select(-quantity), 
                                  by=c("country", "event_code", "specimen_code", "sample_id"))

specimen.sample.codes.with.issues=full_join(specimen.sample.codes.with.issues,
                                  sample.quantity.not.informative %>% select(-quantity), 
                                  by=c("country", "event_code", "specimen_code", "sample_id"))

specimen.sample.codes.with.issues=full_join(specimen.sample.codes.with.issues,
                                  samples.no.test.but.repeated, 
                                  by=c("country", "event_code", "specimen_code", "sample_id"))

specimen.sample.codes.with.issues=full_join(specimen.sample.codes.with.issues,
                                  samples.with.test.and.wo.test, 
                                  by=c("country", "event_code", "specimen_code", "sample_id"))

specimen.sample.codes.with.issues=specimen.sample.codes.with.issues %>% arrange(country, event_code, specimen_code, sample_id)


if(nrow(specimen.sample.codes.with.issues)>0){
  
      # removing columns were everything is NA
specimen.sample.codes.with.issues=specimen.sample.codes.with.issues%>%dplyr::select_if(~ !all(is.na(.)))
  
  
if(any(is.na(specimen.sample.codes.with.issues))){specimen.sample.codes.with.issues[is.na(specimen.sample.codes.with.issues)]="No"}
  
print("Please scroll down the table below to see the complete dataset")  
  
 kableExtra::kbl(specimen.sample.codes.with.issues,
                  caption = "Specimens sample codes with problems") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(c(2:ncol(specimen.sample.codes.with.issues)), border_right = T, width = "8em")%>%

    # kableExtra::collapse_rows(1)
    scroll_box(width = "100%", height = "600px")

}else{
  
  print("No specimen samples present problems")}  

```
#
## SPECIMENS THAT COULD ACTUALLY BE AN OBSERVATION
#
#
#### Are there specimens without a necropsy report, no "necropsy level" reported, and no sample inventory in WHIP? 
#
The specimens that match these three conditions can be confused with observations because there are actually no specimens. Some of these specimens will be repeated above. If you are expecting to conduct a necropsy, please add "Pending Necropsy" in the "Necropsy level" field, or add "No Necropsy". Complete the sample inventory. Record those specimens that are actually observations as observations for tge same event and delete the corresponding specimen.

```{r specimens that could be an observation, no necropsy level or no necropsy reported and no sample inventory, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}


# specimens wo smaples and necropsy


list.of.potential.observations=
dat$spec %>% select(country, specimen_code, sample_type, date_sampled, meta_has_sample_inventory, necropsy_level)%>% # date sampled is mandatory
  distinct()%>%
  arrange(country, specimen_code)%>%
  filter(meta_has_sample_inventory=="No" &
          necropsy_level== "No Necropsy" | is.na(necropsy_level))



if(nrow(list.of.potential.observations)>0){  

list.of.potential.observations.df=
  list.of.potential.observations %>% 
   group_by(country, specimen_code) %>%
  dplyr::summarise(
    specimen_codes = paste(specimen_code, collapse = ", ")) %>% 
  arrange(country) 

  
  print("The data have specimens that could be observations. These are the specimen codes that could be observations")
  
  kableExtra::kbl(list.of.potential.observations.df, 
                  caption = "Specimen codes that could be observations")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("None of the specimens seem to be an observation")}

```
#
# SPECIMEN TESTS
#
#
## TESTS SENT FOR TESTING SINCE THE EVENT DATE
#
#### Were the tests sent for testing since the event date?
#
```{r tests sent since event date, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.sent.testing.earlier.than.event.date=
  dat$spec %>% 
    filter(!is.na(sent_for_testing) & !is.na(event_date))%>%
    filter(!(as.Date(sent_for_testing) >= as.Date(event_date)))%>%
    dplyr::select(country, event_code, specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(test.sent.testing.earlier.than.event.date)>0){  

test.sent.testing.earlier.than.event.date.df=
  test.sent.testing.earlier.than.event.date%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests were sent for testing before the event date. These are the tests that were sent for testing before the event date")
  
  kableExtra::kbl(test.sent.testing.earlier.than.event.date.df, 
                  caption = "Tests sent for testing before the event date")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests were sent for testing since the event date")}

```
#
#
## TESTS SENT FOR TESTING SINCE THE TESTED SPECIMEN WAS FOUND
#
#### Were the tests sent for testing since the source specimens was found?
#
```{r tests sent since specimen found, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.sent.testing.earlier.than.specimen.found=
  dat$spec %>% 
    filter(!is.na(sent_for_testing) & !is.na(date_found))%>%
    filter(!(as.Date(sent_for_testing) >= as.Date(date_found)))%>%
    dplyr::select(country, event_code, specimen_code, disease, sample_source)%>%
    distinct()

if(nrow(test.sent.testing.earlier.than.specimen.found)>0){  

test.sent.testing.earlier.than.specimen.found.df=
  test.sent.testing.earlier.than.specimen.found%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests were sent for testing before the tested specimen was found. These are the tests that were sent for testing before the tested specimen was found")
  
  kableExtra::kbl(test.sent.testing.earlier.than.specimen.found.df, 
                  caption = "Tests sent for testing before the tested specimen was found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests were sent for testing since the event date")}

```
#
#
## TESTS SENT FOR TESTING SINCE THE SAMPLE SOURCE WAS COLLECTED
#
#### Were the tests sent for testing since the sample source was collected?
#
```{r tests sent since sample collected, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.sent.testing.earlier.than.sampling.date=
  dat$spec %>% 
    filter(!is.na(sent_for_testing) & !is.na(date_sampled))%>%
    filter(!(as.Date(sent_for_testing) >= as.Date(date_sampled)))%>%
    dplyr::select(country, event_code, specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(test.sent.testing.earlier.than.sampling.date)>0){  

test.sent.testing.earlier.than.sampling.date.df=
  test.sent.testing.earlier.than.sampling.date%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests were sent for testing before the sample source was collected. These are the tests that were sent for testing before the sample source was collected")
  
  kableExtra::kbl(test.sent.testing.earlier.than.sampling.date.df, 
                  caption = "Tests sent for testing before the sample collection")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests were sent for testing since the sample collection")}

```
#
#
## TESTS RESULTS RECEIVED SINCE THE EVENT DATE
#
#### Were the tests results received since the event date?
#
```{r tests results since event date, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.results.received.earlier.than.event.date=
  dat$spec %>% 
    filter(!is.na(disease_inventory_results_received) & !is.na(event_date))%>%
    filter(!(as.Date(disease_inventory_results_received) >= as.Date(event_date)))%>%
    dplyr::select(country, event_code, specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(test.results.received.earlier.than.event.date)>0){  

test.results.received.earlier.than.event.date.df=
  test.results.received.earlier.than.event.date%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests results were received before the event date. These are the tests results that were received before the event date")
  
  kableExtra::kbl(test.results.received.earlier.than.event.date.df, 
                  caption = "Tests results received before the event date")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests results were received since the event date")}

```
#
#
## TESTS RESULTS RECEIVED SINCE THE TESTED SPECIMEN WAS FOUND
#
#### Were the tests results received since the source specimens were found?
#
```{r tests results since specimen found, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.results.earlier.than.specimen.found=
  dat$spec %>% 
    filter(!is.na(disease_inventory_results_received) & !is.na(date_found))%>%
    filter(!(as.Date(disease_inventory_results_received) >= as.Date(date_found)))%>%
    dplyr::select(country, event_code, specimen_code, disease, sample_source)%>%
    distinct()

if(nrow(test.results.earlier.than.specimen.found)>0){  

test.results.earlier.than.specimen.found.df=
  test.results.earlier.than.specimen.found%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests results were received before the tested specimen was found. These are the tests results that were received before the tested specimen was found")
  
  kableExtra::kbl(test.results.earlier.than.specimen.found.df, 
                  caption = "Tests results received before the tested specimen was found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests results were received since the event date")}

```
#
#
## TESTS RESULTS RECEIVED SINCE THE SAMPLE SOURCE WAS COLLECTED
#
#### Were the tests results received since the sample sources were collected?
#
```{r tests results since sample collected, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.results.earlier.than.sampling.date=
  dat$spec %>% 
    filter(!is.na(disease_inventory_results_received) & !is.na(date_sampled))%>%
    filter(!(as.Date(disease_inventory_results_received) >= as.Date(date_sampled)))%>%
    dplyr::select(country, event_code, specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(test.results.earlier.than.sampling.date)>0){  

test.results.earlier.than.sampling.date.df=
  test.results.earlier.than.sampling.date%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests results were received before the sample source was collected. These are the tests results that were received before the sample source was collected")
  
  kableExtra::kbl(test.results.earlier.than.sampling.date.df, 
                  caption = "Tests results received before the sample collection")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests results were received since the sample collection")}

```
#
#
## TESTS RESULTS RECEIVED SINCE THE TESTS WERE SENT
#
#### Were the tests results received since the tests were sent?
#
```{r tests results since test sent, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.results.earlier.than.test.sent=
  dat$spec %>% 
    filter(!is.na(disease_inventory_results_received) & !is.na(sent_for_testing))%>%
    filter(!(as.Date(disease_inventory_results_received) >= as.Date(sent_for_testing)))%>%
    dplyr::select(country, event_code, specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(test.results.earlier.than.test.sent)>0){  

test.results.earlier.than.test.sent.df=
  test.results.earlier.than.test.sent%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests results were received before the test was sent for testing. These are the tests results that were received before the test was sent")
  
  kableExtra::kbl(test.results.earlier.than.test.sent.df, 
                  caption = "Tests results received before tests were sent")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests results were received since the tests were sent")}

```
#
#
## TESTS WITHOUT THE SOURCE
#
#### Do all tests have the source provided?
#
```{r tests source, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

test.source.not.provided=
  dat$spec %>% 
    filter(is.na(sample_source) & !is.na(disease))%>%
    dplyr::select(country, event_code, specimen_code, sample_source, disease)%>%
    distinct()


if(nrow(test.source.not.provided)>0){  

test.source.not.provided.df=
  test.source.not.provided%>%
  group_by(country, event_code, specimen_code) %>%
  dplyr::summarise(disease_tested = paste(disease, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests do not have their sample source")
  
  kableExtra::kbl(test.source.not.provided.df, 
                  caption = "Tests withut the sample source")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests have their sample source")}

```
#
#
## TESTS WITHOUT METHOD
#
#### Do all tests have the method provided? 
#
```{r tests without the method provided, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

test.method.not.provided=
  dat$spec %>% 
  filter(!is.na(disease) &
         is.na(disease_inventory_test_method)) %>%
    dplyr::select(country, event_code, specimen_code, disease,  sample_source)%>%
    distinct()

if(nrow(test.method.not.provided)>0){  

test.method.not.provided.df=
  test.method.not.provided%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  

  print("No, the data show that some tests do not have the method provided")
  
  kableExtra::kbl(test.method.not.provided.df, 
                  caption = "Tests withput the method provided")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests have their method provided")}
```
#
#
## TESTS WITHOUT THE DATE WHEN THEY WERE SENT FOR TESTING
#
#### Do all tests that a result, result received date, method, or sample source have the date when the test was sent? 
#
```{r tests without , echo=FALSE, warning=FALSE, eval=T, message=FALSE}

test.sent.for.testing.date.not.provided=
  dat$spec %>% 
    filter(is.na(sent_for_testing)) %>% 
    filter(!is.na(disease_inventory_test_result) |
           !is.na(disease) |
           !is.na(disease_inventory_results_received) |
           !is.na(disease_inventory_test_method) |
           !is.na(sample_source))%>%
    dplyr::select(country, event_code, specimen_code, disease,  sample_source)%>%
    distinct()


if(nrow(test.sent.for.testing.date.not.provided)>0){  

test.sent.for.testing.date.not.provided.df=
  test.sent.for.testing.date.not.provided%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests lack the date when these tests were sent")
  
  kableExtra::kbl(test.sent.for.testing.date.not.provided.df, 
                  caption = "Tests with unknown date when they were sent")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests have the date when they were sent")}
```
#
#
## TESTS WITH RESULTS BUT WITHOUT THE DATE WHEN RESULTS WERE RECEIVED
#
#### Do all tests that have a "non-pending" result have the date when the results were received? 
#
```{r tests with results but no date when results arrived, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

test.result.received.date.not.provided=
  dat$spec %>% 
    filter(disease_inventory_test_result!="Pending" & 
           !is.na(disease_inventory_test_result) &
           !is.na(disease) &
           is.na(disease_inventory_results_received))%>%
    dplyr::select(country, event_code, specimen_code, disease,  sample_source)%>%
    distinct()


if(nrow(test.result.received.date.not.provided)>0){  

test.result.received.date.not.provided.df=
  test.result.received.date.not.provided%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests have results but they lack the date when these results arrived")
  
  kableExtra::kbl(test.result.received.date.not.provided.df, 
                  caption = "Tests with results but unknown date when results were received")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests with results have the date when the results arrived")}
```
#
#
## TESTS WITHOUT RESULTS
#
#### Do all tests have their result? Here we scan for tests sent without results at all. Test with "Pending" results are provided in the next section.
#
```{r tests without results, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

test.results.not.provided=
  dat$spec %>% 
    filter(is.na(disease_inventory_test_result) & !is.na(disease))%>%
    dplyr::select(country, event_code, specimen_code, disease,  sample_source)%>%
    distinct()


if(nrow(test.results.not.provided)>0){  

test.results.not.provided.df=
  test.results.not.provided%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests do not have results")
  
  kableExtra::kbl(test.results.not.provided.df, 
                  caption = "Tests without results")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests have results")}
```
#
#
## TESTS WITH RESULTS RECEIVED FROM THE LAB BUT PENDING OR NO RESULT IN THE DATA
#
#### Do tests have pending or no results? Here we scan for tests sent to the lab, with "Pending" results but with date of results received. If the results were received then the test result should not be "pending" or NA status.
#
```{r tests with results received but pending or na in the data, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

test.results.pending=
  dat$spec %>% 
    filter(disease_inventory_test_result=="Pending" | 
           is.na(disease_inventory_test_result) & 
           !is.na(disease_inventory_results_received))%>%
    dplyr::select(country, event_code, specimen_code, disease, sample_source, 
                  disease_inventory_results_received, 
                  disease_inventory_test_result)%>%
    distinct()


if(nrow(test.results.pending)>0){  

test.results.pending.df=
  test.results.pending%>%
  group_by(country, event_code, specimen_code, disease, disease_inventory_results_received) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("Yes, the data show that some tests have their results received but they are still pending to be added to the data")
  
  kableExtra::kbl(test.results.pending.df, 
                  caption = "Tests with results pending")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, bold = T, border_right = T) %>%
    kableExtra::column_spec(5, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(6, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("No, all tests with received results from the lab have the test result different of 'Pending'")}
```
#
## SUMMARY ISSUES AT THE SPECIMEN TESTS LEVEL
#
"Yes" cells indicate problems for the item specified in the corresponding column name.

```{r issues specimen test level, echo=FALSE, warning=FALSE, eval=T, cache=F}


test.sent.testing.earlier.than.event.date$Test_sent_before_event="Yes"

test.sent.testing.earlier.than.specimen.found$Test_sent_before_specimen_found="Yes"

test.sent.testing.earlier.than.sampling.date$Test_sent_before_sampling="Yes"

test.results.received.earlier.than.event.date$Test_received_before_event="Yes"

test.results.earlier.than.specimen.found$Test_received_before_specimen_found="Yes"

test.results.earlier.than.sampling.date$Test_received_before_sampling="Yes"

test.results.earlier.than.test.sent$Test_received_before_test_sent="Yes"

test.source.not.provided$Test_source_not_provided="Yes"

test.method.not.provided$Test_method_not_provided="Yes"

test.sent.for.testing.date.not.provided$Test_sent_date_not_provided="Yes"

test.result.received.date.not.provided$Test_result_received_date_not_provided="Yes"

test.results.not.provided$Test_result_not_provided="Yes"

test.results.pending$Test_result_pending="Yes"


# data showing the issues per event code per country
specimen.tests.with.issues=full_join(test.sent.testing.earlier.than.event.date, 
                                  test.sent.testing.earlier.than.specimen.found,
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))

specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.sent.testing.earlier.than.sampling.date,
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))

specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.results.received.earlier.than.event.date,
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))

specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.results.earlier.than.specimen.found, 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))

specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.results.earlier.than.sampling.date, 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))

specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.results.earlier.than.test.sent, 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))


specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.source.not.provided, 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))

specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.method.not.provided, 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))

specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.sent.for.testing.date.not.provided, 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))


specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.result.received.date.not.provided, 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))


specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.results.not.provided, 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))

specimen.tests.with.issues=full_join(specimen.tests.with.issues,
                                  test.results.pending %>% select(-disease_inventory_results_received, - disease_inventory_test_result), 
                                  by=c("country", "event_code", "specimen_code", "sample_source", "disease"))



specimen.tests.with.issues=specimen.tests.with.issues %>% arrange(country, event_code, specimen_code, sample_source, disease)


if(nrow(specimen.tests.with.issues)>0){
  
      # removing columns were everything is NA
specimen.tests.with.issues=specimen.tests.with.issues%>%dplyr::select_if(~ !all(is.na(.)))
  
  
if(any(is.na(specimen.tests.with.issues))){specimen.tests.with.issues[is.na(specimen.tests.with.issues)]="No"}
  
print("Please scroll down the table below to see the complete dataset")  
  
 kableExtra::kbl(specimen.tests.with.issues,
                  caption = "Specimens tests with problems") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(c(2:ncol(specimen.tests.with.issues)), border_right = T, width = "8em")%>%

    # kableExtra::collapse_rows(1)
    scroll_box(width = "100%", height = "600px")

}else{
  
  print("No specimen test present problems")}  

```
#
## TESTS THAT COULD BE REPEATED
#
#
#### Are there tests that have the same test information. If test data is repeated twice or more it DOES NOT imply that a single test was entered in the database more tha once, but it is very suggestive it was (it is possible that two tests were conducted in the same lab, using the same source, targeting the same disease, using the same method, getting the same result, and the tests could have been sent the same date, and their results received the same date. But it is also possible that it is the same test entered wrongly more than once). These data needs to be double checked and not necessarily corrected.
#
```{r tests that could be repeated same infomration, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

# tests
list.of.potential.repeated.tests=
dat$spec %>% 
  filter(!is.na(sample_source)) %>% 
  select(country,
         event_code,
         specimen_code,
         testing_lab,
         sample_source, 
         disease, 
         disease_inventory_test_method, 
         sent_for_testing, 
         disease_inventory_results_received,
         disease_inventory_test_result) %>%
  group_by_all() %>% 
  summarise(times_repeated = n()) %>% 
  filter(times_repeated>1) %>%
  ungroup()
 

if(nrow(list.of.potential.repeated.tests)>0){  

  print("The data have tests that could be repeated. These are the tests that could be repeated")
  
  kableExtra::kbl(list.of.potential.repeated.tests, 
                  caption = "Tests that could be repeated")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2:4, border_right = T) %>%
    kableExtra::column_spec(5, width = "30em", bold = T, border_right = T) %>%
    kableExtra::column_spec(6:10, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("None of the tests seem to be repeated")}

```
#
# ENVIRONMENTAL SPECIMENS 
#
#
## FUNDING SOURCE PROJECT TAG PROVIDED
#
#### Do all the environmental specimens have the funding source project tag?
#
#
```{r funding project tag provided env specimens, echo=FALSE, warning=FALSE, eval=T, message=FALSE}


#events with data wo funding source project tag

env.specimens.funding.source.project.tag.not.provided=
dat$env_spec %>% 
  filter(!grepl(paste(years, collapse = "|"), dat$env_spec$environmental_specimen_project_tags)) %>% 
  select(country, event_code, environmental_specimen_code) %>% distinct()


if(nrow(env.specimens.funding.source.project.tag.not.provided)>0){
  

env.specimens.funding.source.project.tag.not.provided.df=
  env.specimens.funding.source.project.tag.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", "))
    
  
# Show the results
      
    print("No. Not all the environmental specimens have funding project tag. These are the environmental specimens without a funding project tag")
  
    kableExtra::kbl(env.specimens.funding.source.project.tag.not.provided.df, 
                    caption = "Environmental specimens codes without funding agency projec tag") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em")%>%
      scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the environmental specimens have the funding project tag")}

  

```
#
## SURVEILLANCE PROJECT TAG PROVIDED
#
#### Do all the environmental specimens have the surveillance project tag?
#
#
```{r type of surveillance tag provided env specimens, echo=FALSE, warning=FALSE, eval=T, message=FALSE}



env.specimens.surveillance.project.tag.not.provided=
dat$env_spec %>% 
  filter(!grepl(paste(countries.project.tags, collapse = "|"), dat$env_spec$environmental_specimen_project_tags)) %>% 
  select(country, event_code, environmental_specimen_code) %>% distinct()


if(nrow(env.specimens.surveillance.project.tag.not.provided)>0){
  

env.specimens.surveillance.project.tag.not.provided.df=
  env.specimens.surveillance.project.tag.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", "))
    

  
# Show the results
      
    print("No. Not all the environmental specimens have surveillance project tag. These are the environmental specimens without a surveillance project tag")
  
    kableExtra::kbl(env.specimens.surveillance.project.tag.not.provided.df, 
                    caption = " Environmental Specimen codes without surveillance project tag") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em") %>%
      scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the environmental specimens have the surveillance project tag")}


```
#
## SURVEILLANCE OUTBREAK UNIT
#
#### Do all the environmental specimens have the surveillance or outbreak unit?
#
#
```{r surveillance or outbreak unit env specimens, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.spec.surveillance.unit.not.provided=
dat$env_spec %>% 
  filter(!grepl("Scanning_", dat$env_spec$environmental_specimen_project_tags) &
         is.na(id_surveillance_or_outbreak_unit)) %>% 
  select(country, event_code, environmental_specimen_code) %>% distinct()


if(nrow(env.spec.surveillance.unit.not.provided)>0){
  

env.spec.surveillance.unit.not.provided.df=
  env.spec.surveillance.unit.not.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_code = paste(environmental_specimen_code, collapse = ", "))
  
# Show the results
      
    print("No. Not all the environmental specimens not from scanning surveillance unit have the surveillance or outbreak unit provided. These are the environmental specimens without the scanning surveillance")
  
    kableExtra::kbl(env.spec.surveillance.unit.not.provided.df, 
                    caption = "Environmental specimens without surveillance or outbreak unit") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "30em") %>%
      scroll_box(width = "100%", height = "600px")}else{#}

    print("Yes, all the environmental specimens have the surveillance or outbreak unit")}


```
#
## ENVIRONMENTAL SPECIMENS IDs PROVIDED 
#
#
#### Do all the environmental specimens have the environmental specimen id provided?
#
#
```{r env specimen id, echo=FALSE, cache=FALSE, eval=T, message=FALSE}

env.specimen.codes.with.env.ids.as.na=
          dat$env_spec %>% 
          filter(is.na(environmental_specimen_id)) %>% 
  select(country, event_code, environmental_specimen_code) %>% distinct()

if(nrow(env.specimen.codes.with.env.ids.as.na)>0){  

env.specimen.codes.with.env.ids.as.na.df=
  env.specimen.codes.with.env.ids.as.na%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", "))
    

  print("No. Not all environmental specimen ids are provided. These are the environmental specimens whose environmental specimen ids are NA")
  
  kableExtra::kbl(env.specimen.codes.with.env.ids.as.na.df, 
                      caption = "Environmental specimens with no environmental specimens IDs") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em")%>%
    scroll_box(width = "100%", height = "600px")}else{

    print("Yes, all environmental specimens IDs are provided")}

```
#
## ENVIRONMENTAL SPECIMEN ID UNIQUE FOR A SINGLE ENVIRONMENTAL SPECIMEN
#
#### Do all the environmental specimens have a unique environmental specimen id? 
#
#
```{r env specimen unique, echo=FALSE, warning=FALSE, cache=FALSE, eval=T, message = FALSE}

# each specimen code has a single animal id?

env.specimen.codes.with.more.than.one.env.spec.ids=
  dat$env_spec %>% 
  filter(!is.na(environmental_specimen_id))%>%
  distinct(environmental_specimen_code, environmental_specimen_id) %>% 
  count(environmental_specimen_id) %>% 
  filter(n>1)%>%
  pull(environmental_specimen_id)

env.specimen.codes.with.more.than.one.env.spec.ids=
  dat$env_spec %>% 
  filter(environmental_specimen_id %in% env.specimen.codes.with.more.than.one.env.spec.ids) %>% 
  dplyr::select(country, event_code, environmental_specimen_code, environmental_specimen_id) %>% 
  distinct() %>% 
  arrange(environmental_specimen_id)


  
if(nrow(env.specimen.codes.with.more.than.one.env.spec.ids)>0){  

env.specimen.codes.with.more.than.one.env.spec.ids.df=
  env.specimen.codes.with.more.than.one.env.spec.ids%>%
  group_by(country, environmental_specimen_id) %>%
  dplyr::summarise(
    event_codes = paste(event_code, collapse = ", "), 
    environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  
    
    
  print("No, not all environmental specimen ids are under a single environmental specimen code. These are environmental specimen ids for more than one environmental specimen")

    
    kableExtra::kbl(env.specimen.codes.with.more.than.one.env.spec.ids.df, 
                    caption = "Environmental specimen ids used in more than one environmental specimen code") %>%
      kableExtra::kable_paper(full_width = F) %>%
      kableExtra::column_spec(1, bold = T, border_right = T) %>%            
      kableExtra::column_spec(2, bold = T, border_right = T) %>%
      kableExtra::column_spec(3, width = "50em") %>% 
      kableExtra::column_spec(4, width = "50em") %>%
      scroll_box(width = "100%", height = "600px")}else{#}

        print("Yes, all environmental specimen ids are used for a single environmental specimen")}

```

<!-- # -->
<!-- # -->
<!-- ##### Do the Animal IDs follow the standardized labeling structure? -->
<!-- # -->
<!-- # ```{r checking animal ids 2, echo=FALSE, warning=FALSE, cache=FALSE, eval=F} -->
<!-- #  -->
<!-- # # Structure of animal IDs follow the standardized frame -->
<!-- # country.abbreviations=c("KH", "LA", "VN") -->
<!-- #  -->
<!-- # project.abbreviations=c("W") -->
<!-- #  -->
<!-- # taxa=list(A="Amphibian", B="Bat", C="Carnivore", -->
<!-- #           E="Elephant", F="Fish", G="Pangolin", -->
<!-- #           L="Reptile", M="Marine mammal", P="Primate", -->
<!-- #           R="Rodent", S="Swine", U="Ungulate", -->
<!-- #           W="Wild bird", X="Environmental") -->
<!-- #  -->
<!-- # project.country.abbreviations=paste0(rep(project.abbreviations, -->
<!-- #                                          each = length(country.abbreviations)) -->
<!-- #                                      , country.abbreviations, "-") -->
<!-- #  -->
<!-- # # first part of animal ids when they are not NA -->
<!-- # first.part.animal.ids.project.country.hyphen= # one letter for project, 2 letters for country, and hyphen -->
<!-- #   substr(spec[!is.na(spec$Animal_ID),]$Animal_ID, 1,4)  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # # in the first part of the label -->
<!-- # first.part.animal.ids.is.correct=all( -->
<!-- #    -->
<!-- #   substring(first.part.animal.ids.project.country.hyphen, 1,1)%in%project.abbreviations & # first piece does have a valid project letter? -->
<!-- #      -->
<!-- #     substring(first.part.animal.ids.project.country.hyphen, 2,3)%in%country.abbreviations & # second piece has valid country abbreviations? -->
<!-- #      -->
<!-- #     substring(first.part.animal.ids.project.country.hyphen, 4)=="-") # third piece is a hyphen?  -->
<!-- #  -->
<!-- #  -->
<!-- #  -->
<!-- # #in the second part of the label -->
<!-- # second.part.animal.ids.taxa.numeric=  # one letter for taxa, 3 numbers -->
<!-- #   sapply(strsplit(spec[!is.na(spec$Animal_ID),]$Animal_ID, "-"), function(x) x[2]) -->
<!-- #  -->
<!-- #  -->
<!-- # #id second part of the animal id structure -->
<!-- # second.part.animal.ids.is.correct=all( -->
<!-- #    -->
<!-- #   substring(second.part.animal.ids.taxa.numeric, 1,1)%in%names(taxa) & # first piece does have a valid taxa letter? -->
<!-- #      -->
<!-- #     !is.na(as.numeric(substring(second.part.animal.ids.taxa.numeric, 2,4)))) # second piece: cgaracters 2 to 4 can be moved to a number -->
<!-- #  -->
<!-- #  -->
<!-- # wrong.animal.id.first.part= -->
<!-- #    -->
<!-- #   spec[!is.na(spec$Animal_ID),]$Animal_ID[ -->
<!-- #      -->
<!-- #     !(substring(first.part.animal.ids.project.country.hyphen, 1,1)%in%project.abbreviations) | # first piece does have a valid project letter? -->
<!-- #        -->
<!-- #       !(substring(first.part.animal.ids.project.country.hyphen, 2,3)%in%country.abbreviations) | # second piece has valid country abbreviations? -->
<!-- #        -->
<!-- #       substring(first.part.animal.ids.project.country.hyphen, 4)!="-"] -->
<!-- #    -->
<!-- #    -->
<!-- # wrong.animal.id.second.part= -->
<!-- #    -->
<!-- #   spec[!is.na(spec$Animal_ID),]$Animal_ID[ -->
<!-- #      -->
<!-- #     !(substring(second.part.animal.ids.taxa.numeric, 1,1)%in%names(taxa)) | # first piece does have a valid taxa letter? -->
<!-- #        -->
<!-- #       is.na(as.numeric(substring(second.part.animal.ids.taxa.numeric, 2,4)))] -->
<!-- #    -->
<!-- #    -->
<!-- # wrong.animal.id=sort(unique(wrong.animal.id.first.part, wrong.animal.id.second.part)) -->
<!-- #    -->
<!-- #   -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country= -->
<!-- # lapply(data.per.country.spec, function(x) -->
<!-- # x%>% -->
<!-- #   filter(!is.na(Animal_ID) & Animal_ID%in%wrong.animal.id)%>% -->
<!-- #   dplyr::select(Country, Specimen_code)%>% -->
<!-- #   distinct(Country, Specimen_code)) -->
<!-- #  -->
<!-- #    -->
<!-- # if(nrow(do.call(rbind, specimen.codes.with.wrong.animal.ids.per.country))>0){   -->
<!-- #  -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country= -->
<!-- #   do.call( -->
<!-- #   rbind, specimen.codes.with.wrong.animal.ids.per.country)%>% -->
<!-- #   dplyr::select(Country, Specimen_code) -->
<!-- #  -->
<!-- # # spit the data by country again now including the data of country based on the project tag -->
<!-- # # for those rows wo country -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country= -->
<!-- # lapply(sort(unique(specimen.codes.with.wrong.animal.ids.per.country$Country)), function(x)  -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country%>%filter(Country==x)%>% -->
<!-- #   dplyr::select(Country, Specimen_code)%>% -->
<!-- #   distinct(Country, Specimen_code)) -->
<!-- #  -->
<!-- # # name the list -->
<!-- # names(specimen.codes.with.wrong.animal.ids.per.country)=sapply( -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country, function(x) unique(x$Country)) -->
<!-- #      -->
<!-- # # order by specimen code -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country= -->
<!-- #   lapply(specimen.codes.with.wrong.animal.ids.per.country, function(x) -->
<!-- #   x[order(x[,"Specimen_code"]), ]) -->
<!-- #  -->
<!-- # # move to da dataset with the event codes in a single row -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country.df= -->
<!-- #   lapply(specimen.codes.with.wrong.animal.ids.per.country, function(x) -->
<!-- #   data.frame(Specimen_code=paste(unique(x$Specimen_code), collapse = " "))) -->
<!-- #  -->
<!-- #  -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country.df=data.frame( -->
<!-- #     Country=names(specimen.codes.with.wrong.animal.ids.per.country.df),  -->
<!-- #     Specimen_code=unlist(specimen.codes.with.wrong.animal.ids.per.country.df, use.names = F)) -->
<!-- #  -->
<!-- #    specimen.codes.with.wrong.animal.ids.per.country.df= -->
<!-- #      specimen.codes.with.wrong.animal.ids.per.country.df[ -->
<!-- #        specimen.codes.with.wrong.animal.ids.per.country.df$Specimen_code!="",] -->
<!-- #  -->
<!-- #    #delete rownames -->
<!-- #   rownames(specimen.codes.with.wrong.animal.ids.per.country.df)=NULL -->
<!-- #    -->
<!-- #         # subset to specific country -->
<!-- # specimen.codes.with.wrong.animal.ids.per.country.df= -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country.df%>%filter(Country==params$country.of.interest) -->
<!-- #  -->
<!-- # if(nrow(specimen.codes.with.wrong.animal.ids.per.country.df)>0){ -->
<!-- #  -->
<!-- #    -->
<!-- #     print("No. Not all animal IDs provided follow the label format. These are the animal IDs with wrong format. Please -->
<!-- # scroll the table below down and left-right to see the complete dataset if needed", appendLF = T) -->
<!-- #      -->
<!-- #   kableExtra::kbl(specimen.codes.with.wrong.animal.ids.per.country.df,  -->
<!-- #                   caption = "Specimen codes with wrong Animal IDs per country") %>% -->
<!-- #     kableExtra::kable_paper(full_width = F) %>% -->
<!-- #     kableExtra::column_spec(1, bold = T, border_right = T) %>% -->
<!-- #     kableExtra::column_spec(2, width = "30em") -->
<!-- #  -->
<!-- # }} -->
<!-- #  -->
<!-- # if(!exists("specimen.codes.with.wrong.animal.ids.per.country.df") | -->
<!-- #     exists("specimen.codes.with.wrong.animal.ids.per.country.df") &&  -->
<!-- #    nrow(specimen.codes.with.wrong.animal.ids.per.country.df)==0){   -->
<!-- #  -->
<!-- #   specimen.codes.with.wrong.animal.ids.per.country=list(data.frame(Country="", Observation_code="")) -->
<!-- #     -->
<!-- #   rownames(specimen.codes.with.wrong.animal.ids.per.country[[1]])<-NULL -->
<!-- #      -->
<!-- #      -->
<!-- #   print("Yes, all animal IDs provided have the correct format")} -->
<!-- #  -->
<!-- # ``` -->
#
## ENVIRONMENTAL SPECIMENS WITH DATE FOUND
#
#
#### Do all environmental specimens have the date they were found provided?
#
#
```{r env speciemens date found provided, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.spec.codes.date.found.provided=
dat$env_spec%>%
    filter(is.na(environmental_specimen_date_found)) %>%  # I requested to have the colname changed to "date_found"
    dplyr::select(country, event_code, environmental_specimen_code, environmental_specimen_date_found)%>%
    distinct()#)

if(nrow(env.spec.codes.date.found.provided)>0){  


env.spec.codes.date.found.provided.df=
  env.spec.codes.date.found.provided %>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  

  
  print("No, the data show that some environmental specimens do not have the date found. These are the environmental specimens are missing the date they were found")
  
  kableExtra::kbl(env.spec.codes.date.found.provided.df, 
                  caption = "Environmental specimens without the date they were found")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all environmental specimens have the date they were found")} # test
 
```
#
## ENVIRONMENTAL SPECIMENS FOUND SINCE THE EVENT DATE
#
#
#### Were all environmental specimens collected since the corresponding event date?
#
#
<!-- Date found was not mandatory until Feb 2, 2021, so several rows without this information. See below to check which specimens do not have the date found provided. -->
```{r env specimen date, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.spec.codes.date.found.earlier.date=
  # lapply(dat, function(x)
dat$env_spec%>%
    filter(!(as.Date(event_date)<=as.Date(environmental_specimen_date_found)))%>%
    dplyr::select(country, event_code, environmental_specimen_code)%>%
    distinct()#)

if(nrow(env.spec.codes.date.found.earlier.date)>0){  

env.spec.codes.date.found.earlier.date.df=
  env.spec.codes.date.found.earlier.date%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  

  
  print("No, the data show that some environmental specimens were collected before the event. These are the environmental specimens that were found earlier than the event")
  
  kableExtra::kbl(env.spec.codes.date.found.earlier.date.df, 
                  caption = "Environmental specimens with inconsistency between the event date and the date they were found")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all specimens were found since the corresponding event")}
  
```
#
## ENVIRONMENTAL SPECIMENS SPECIES PROVIDED
#
#
#### Do all environmental specimens have a species assigned?
#
#
Remember that you could add higher taxonomic levels such as "Aves", or more specific levels such as order, family, or genus. The list below does not include soil, water, or sediment specimens.
```{r env specimen species, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

env.spec.species.not.reported=

dat$env_spec%>%
    filter(is.na(environmental_specimen_common_name)) %>% 
    filter(environmental_specimen_type%in%c("WA - Water", "SD - Sediment", "SO - Soil")) %>% 
    dplyr::select(country, event_code, environmental_specimen_code) %>%
    distinct()


if(nrow(env.spec.species.not.reported)>0){  

env.spec.species.not.reported.df=
  env.spec.species.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some environmental specimens do not have the species. These are the Environmental specimen codes that do not have the species reported")
  
  kableExtra::kbl(env.spec.species.not.reported.df, 
                  caption = "Environmental specimens species not provided")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all environmental specimens have species reported")}
  

```
#
## ENVIRONMENTAL SPECIMENS WITH FOUND BY
#
#
#### Do all environmental specimens have the person that found them?
#
#
```{r env specimen found by, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

env.spec.found.by.not.reported=

dat$env_spec%>%
    filter(is.na(environmental_specimen_how_found)) %>% 
    dplyr::select(country, event_code, environmental_specimen_code)%>%
    distinct()


if(nrow(env.spec.found.by.not.reported)>0){  

env.spec.found.by.not.reported.df=
  env.spec.found.by.not.reported%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some environmental specimens do not have who found them. These are the Environmental specimen codes that do not have the 'found by' field reported")
  
  kableExtra::kbl(env.spec.found.by.not.reported.df, 
                  caption = "Environmental specimens that is unknown how they were found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all envinronmental specimens have the found by item reported")}
  

```
#
## ENVIRONMENTAL SPECIMENS TYPE PROVIDED
#
#
#### Do all environmental specimens have their type provided?
#
#
```{r environnmental specimen type provided, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

env.spec.type.provided=
dat$env_spec %>% 
  filter(is.na(environmental_specimen_type) & meta_has_environmental_specimen_sample_inventory=="Yes") %>% 
  dplyr::select(country, event_code, environmental_specimen_code)%>%
  distinct()

if(nrow(env.spec.type.provided)>0){  

env.spec.type.provided.df=
  env.spec.type.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some environmental specimens their type not provided. These are the Environmental Specimen codes whose type is not provided")
  
  kableExtra::kbl(env.spec.sample.types.provided.df, 
                  caption = "Environmental specimens of unknown type")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all the environmental specimen types are provided")}


```
#
## SUMMARY ISSUES AT THE ENVIRONMENTAL SPECIMEN LEVEL
#
"Yes" cells indicate problems for the item specified in the corresponding column name. Absence of a table below means that there are not issues at the environmental specimen level.

```{r issues environmental specimen level, echo=FALSE, warning=FALSE, eval=T, cache=F}


#data frame event codes without fundgin project tag

env.specimens.funding.source.project.tag.not.provided$No_funding_project_tag="Yes"

#data frame event codes without surveillance project tag

env.specimens.surveillance.project.tag.not.provided$No_surveillance_project_tag="Yes"

#data frame specimens codes without surveillance or outbreak unit

env.spec.surveillance.unit.not.provided$No_surveillance_outbreak_unit="Yes"

#data frame specimens codes without environmental specimen id

#env.specimen.codes.with.env.ids.as.na$No_env_specimen_id="Yes"

#data frame animal id in more than one specimen

# env.specimen.codes.with.more.than.one.env.spec.ids$Repeated_env_spec_id="Yes"

#data frame specimens codes without observed date

env.spec.codes.date.found.provided$No_found_date="Yes"

#data frame specimens codes found earlier than event date

env.spec.codes.date.found.earlier.date$Found_before_event_date="Yes"


env.spec.species.not.reported$No_species="Yes"


env.spec.found.by.not.reported$No_found_by="Yes"


env.spec.type.provided$No_env_spec_type="Yes"


# data showing the issues per event code per country
env.specimen.codes.with.issues=full_join(env.specimens.funding.source.project.tag.not.provided, 
                                  env.specimens.surveillance.project.tag.not.provided,
                                  by=c("country", "event_code", "environmental_specimen_code"))

env.specimen.codes.with.issues=full_join(env.specimen.codes.with.issues,
                                  env.spec.surveillance.unit.not.provided,
                                  by=c("country", "event_code", "environmental_specimen_code"))

# env.specimen.codes.with.issues=full_join(env.specimen.codes.with.issues,
#                                   env.specimen.codes.with.env.ids.as.na,
#                                   by=c("country", "event_code", "environmental_specimen_code"))

# env.specimen.codes.with.issues=full_join(env.specimen.codes.with.issues,
#                                   env.specimen.codes.with.more.than.one.env.spec.ids,
#                                   by=c("country", "event_code", "environmental_specimen_code"))

env.specimen.codes.with.issues=full_join(env.specimen.codes.with.issues,
                                  env.spec.codes.date.found.provided, 
                                  by=c("country", "event_code", "environmental_specimen_code"))

env.specimen.codes.with.issues=full_join(env.specimen.codes.with.issues,
                                  env.spec.codes.date.found.earlier.date, 
                                  by=c("country", "event_code", "environmental_specimen_code"))

env.specimen.codes.with.issues=full_join(env.specimen.codes.with.issues,
                                  env.spec.species.not.reported, 
                                  by=c("country", "event_code", "environmental_specimen_code"))

env.specimen.codes.with.issues=full_join(env.specimen.codes.with.issues,
                                  env.spec.found.by.not.reported, 
                                  by=c("country", "event_code", "environmental_specimen_code"))

env.specimen.codes.with.issues=full_join(env.specimen.codes.with.issues,
                                  env.spec.type.provided, 
                                  by=c("country", "event_code", "environmental_specimen_code"))



env.specimen.codes.with.issues=env.specimen.codes.with.issues %>% arrange(country, event_code, environmental_specimen_code)


if(nrow(env.specimen.codes.with.issues)>0){
  
      # removing columns were everything is NA
env.specimen.codes.with.issues=env.specimen.codes.with.issues%>%dplyr::select_if(~ !all(is.na(.)))
  
  
if(any(is.na(env.specimen.codes.with.issues))){env.specimen.codes.with.issues[is.na(env.specimen.codes.with.issues)]="No"}
  
print("Please scroll down the table below to see the complete dataset")  
  
 kableExtra::kbl(env.specimen.codes.with.issues,
                  caption = "Environmental specimens codes with problems") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(c(2:ncol(env.specimen.codes.with.issues)), border_right = T, width = "8em")%>%

    # kableExtra::collapse_rows(1)
    scroll_box(width = "100%", height = "600px")

}else{
  
  print("No environmental specimen codes present problems")}  

```
#
# ENVIRONMENTAL SPECIMEN SAMPLES
#
#
## SAMPLING DATE SINCE THE EVENT DATE
#
#### Were the environmental samples collected since the date the corresponding event date?
#
#
```{r environmental sample dates, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


env.sample.date.collected.earlier.than.event.date=
  dat$env_spec %>% 
    filter(!is.na(date_sampled) & !is.na(event_date))%>%
    filter(!(as.Date(date_sampled) >= as.Date(event_date)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, environmental_specimen_sample_id)%>%
    distinct()


if(nrow(env.sample.date.collected.earlier.than.event.date)>0){  

env.sample.date.collected.earlier.than.event.date.df=
  env.sample.date.collected.earlier.than.event.date%>%
  group_by(country, event_code, environmental_specimen_code) %>%
  dplyr::summarise(environmental_specimen_sample_ids = paste(environmental_specimen_sample_id, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some environmental samples were collected before the event date. These are the environmental samples that were collected before the event date")
  
  kableExtra::kbl(env.sample.date.collected.earlier.than.event.date.df, 
                  caption = "Environmental samples collected before the event date")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all environmental samples were collected since the event date")}

```
#
## SAMPLING SINCE THE SOURCE ENVIRONMENTAL SPECIMEN WAS FOUND
#
#
#### Were the environmental samples collected since the date the source environmental specimen was found?
#
#
```{r environmental sample dates 2, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}

env.sample.date.collected.earlier.than.specimen.found=
  dat$env_spec %>% 
    filter(!is.na(date_sampled) & !is.na(environmental_specimen_date_found))%>%
    filter(!(as.Date(date_sampled) >= as.Date(environmental_specimen_date_found)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, environmental_specimen_sample_id)%>%
    distinct()


if(nrow(env.sample.date.collected.earlier.than.specimen.found)>0){  

env.sample.date.collected.earlier.than.specimen.found.df=
  env.sample.date.collected.earlier.than.specimen.found%>%
  group_by(country, event_code, environmental_specimen_code) %>%
  dplyr::summarise(environmental_specimen_sample_ids = paste(environmental_specimen_sample_id, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some environmental samples were collected before the environmental specimen was found. These are the environmental samples that were collected before the environmental specimen was found.")
  
  kableExtra::kbl(env.sample.date.collected.earlier.than.specimen.found.df, 
                  caption = "Environmental samples collected before the environmental specimen was found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all environmental samples were collected since the environmental specimen was found")}



```
#
## ENVIRONMENTAL SAMPLE IDS PROVIDED
#
#
#### Are all the environmental sample IDs provided?
#
#
```{r environmental sample id provided, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

env.spec.sample.ids.provided=
dat$env_spec %>% 
  filter(is.na(environmental_specimen_sample_id) & meta_has_environmental_specimen_sample_inventory=="Yes") %>% 
  dplyr::select(country, event_code, environmental_specimen_code)%>%
  distinct()

if(nrow(env.spec.sample.ids.provided)>0){  

env.spec.sample.ids.provided.df=
  env.spec.sample.ids.provided%>%
  group_by(country, event_code) %>%
  dplyr::summarise(environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some environmental specimens have samples but their sample ids are not provided. These are the Environmental specimen codes with samples without ids")
  
  kableExtra::kbl(env.spec.sample.ids.provided.df, 
                  caption = "Environmental specimens have samples without ids")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    # kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all the environmental samples have sample id")}


```

<!-- # -->
<!-- # -->
<!-- ##### Do the env sample IDs follow the standardized labeling structure? -->
<!-- # -->
```{r env sample ids 2, echo=FALSE, warning=FALSE, eval=F, cache=FALSE}

country.abbreviations=c("KH", "LA", "VN")

project.abbreviations=c("W")

taxa=list(A="Amphibian", B="Bat", C="Carnivore",
          E="Elephant", F="Fish", G="Pangolin",
          L="Reptile", M="Marine mammal", P="Primate",
          R="Rodent", S="Swine", U="Ungulate",
          W="Wild bird", X="Environmental")

project.country.abbreviations=paste0(rep(project.abbreviations,
                                         each = length(country.abbreviations))
                                     , country.abbreviations, "-")


sample.type=c("OS", "RS", "NS", "US", "FF", "DF", "UR", "CC", "GC", "VM",
              "FL", "JF", "CF", "ML", "BW","BP", "BS", "BC", "AG", "BM", 
              "BN", "BR", "ES", "EY", "GB", "FR", "FS", "HT", "HR", "IL",
              "IS", "KD", "LN", "LU", "LV", "MG", "MT", "MU", "NV", "OV", "PN",
              "SC", "SK", "SP", "ST", "TG", "TO", "TN", "TR", "TS", "UB", "UM",
              "UT", "DM", "SM", "FM", "PL", "PM", "PT", "PF", "PR", "PP", "PZ",
              "FP", "PO", "SD", "SL", "WA")

medium = c("A", "B", "F", "P", "R", "T", "U", "V")

# where sample ID are provided
spec.sample.id.provided=spec[!is.na(spec$Sample_ID),]

# first part of sample ids when they are not NA
first.part.sample.ids.project.country.hyphen= # one letter for project, 2 letters for country, and hyphen
  substr(spec.sample.id.provided$Sample_ID, 1,5) 

#in the second part of the label
second.part.sample.ids.taxa.numeric=  # one letter for taxa, 3 numbers
  sapply(strsplit(spec.sample.id.provided$Sample_ID, "-"), function(x) x[2])


#in the third part of the label

third.part.sample.ids.taxa.numeric=  # two letter for sample type, 
  sapply(strsplit(spec.sample.id.provided$Sample_ID, "-"), function(x) x[3])

# in the fourth part of the label

fourth.part.sample.ids.taxa.numeric=  # one letter for taxa, 3 numbers
  sapply(strsplit(spec.sample.id.provided$Sample_ID, "-"), function(x) x[4])




  wrong.sample.id.first.part=
    
    spec.sample.id.provided$Sample_ID[
      
      !(substring(first.part.sample.ids.project.country.hyphen, 1,1)%in%project.abbreviations) | # first piece does have a valid project letter?
        
        !(substring(first.part.sample.ids.project.country.hyphen, 2,3)%in%country.abbreviations) | # second piece has valid country abbreviations?
        
        substring(first.part.sample.ids.project.country.hyphen, 4,4)!="-"]
  
  
  
  
  wrong.sample.id.second.part=
    
    spec.sample.id.provided$Sample_ID[
      
      !(substring(second.part.sample.ids.taxa.numeric, 1,1)%in%names(taxa)) | # second piece does have a valid taxa letter?
        
        is.na(as.numeric(substring(second.part.sample.ids.taxa.numeric, 2,4)))]
  
  
  
  
  wrong.sample.id.third.part=
    
    spec.sample.id.provided$Sample_ID[ #third piece does ahave a valid sample type abb
    
    !(substring(third.part.sample.ids.taxa.numeric, 1,2)%in%sample.type) & 
    
    nchar(third.part.sample.ids.taxa.numeric)!=2] # then there is nothing afterwards
    
  
    
  
  wrong.sample.id.fourth.part=spec.sample.id.provided$Sample_ID[ #fourth piece does a have a valid medium type
    
    !(substring(fourth.part.sample.ids.taxa.numeric, 1)%in%medium)]
    
  
  # wrong sample ids
  wrong.sample.id=sort(unique(c(wrong.sample.id.first.part, 
                                wrong.sample.id.second.part, 
                                wrong.sample.id.third.part, 
                                wrong.sample.id.fourth.part)))
  
  
  
  specimen.codes.with.wrong.sample.ids.per.country=
  lapply(data.per.country.spec, function(x)
  x%>%
  filter(!is.na(Sample_ID) & Sample_ID%in%wrong.sample.id))

  
  if(nrow(do.call(rbind, specimen.codes.with.wrong.sample.ids.per.country))>0){

  specimen.codes.with.wrong.sample.ids.per.country=
  do.call(
  rbind, specimen.codes.with.wrong.sample.ids.per.country)%>%
  dplyr::select(Country, Event_Code, Specimen_code,  Sample_ID, Sample_type, Medium_Type, Date_Sampled)

# spit the data by country again now including the data of country based on the project tag
# for those rows wo country
specimen.codes.with.wrong.sample.ids.per.country=
lapply(sort(unique(specimen.codes.with.wrong.sample.ids.per.country$Country)), function(x) 
  specimen.codes.with.wrong.sample.ids.per.country%>%filter(Country==x)%>%
  dplyr::select(Country, Event_Code, Specimen_code, Sample_ID, Sample_type, Medium_Type, Date_Sampled)%>%
  distinct(Country, Event_Code, Specimen_code,  Sample_ID, Sample_type, Medium_Type, Date_Sampled))

# name the list
names(specimen.codes.with.wrong.sample.ids.per.country)=sapply(
  specimen.codes.with.wrong.sample.ids.per.country, function(x) unique(x$Country))
    

# move to da dataset with the event codes in a single row
specimen.codes.with.wrong.sample.ids.per.country.df=
do.call(rbind, specimen.codes.with.wrong.sample.ids.per.country)

#order by country and specimen code
specimen.codes.with.wrong.sample.ids.per.country.df=
  specimen.codes.with.wrong.sample.ids.per.country.df[order(
    specimen.codes.with.wrong.sample.ids.per.country.df$Country, 
    specimen.codes.with.wrong.sample.ids.per.country.df$Specimen_code),]

   #delete rownames
  rownames(specimen.codes.with.wrong.sample.ids.per.country.df)=NULL 

   # subset to specific country
specimen.codes.with.wrong.sample.ids.per.country.df=
specimen.codes.with.wrong.sample.ids.per.country.df%>%filter(Country==params$country.of.interest)

if(nrow(specimen.codes.with.wrong.sample.ids.per.country.df)>0){  
  
  
    print("No. Not all sample IDs provided follow the label format. These are the sample IDs with wrong format.
Please scroll the table below down and left-right to see the complete dataset if needed", appendLF = T)

    
  kableExtra::kbl(specimen.codes.with.wrong.sample.ids.per.country.df, 
                  caption = "Wrong sample IDs per country") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2:6, border_right = T, width = "15em")%>%
    # collapse_rows(columns = 2:3)%>%
    scroll_box(width = "100%", height = "600px")
    
}}

  if(!exists("specimen.codes.with.wrong.sample.ids.per.country.df") |
    exists("specimen.codes.with.wrong.sample.ids.per.country.df") && 
   nrow(specimen.codes.with.wrong.sample.ids.per.country.df)==0){  

  specimen.codes.with.wrong.sample.ids.per.country=list(
    data.frame(Country="", 
               Event_Code="", 
               Specimen_code="", 
               Sample_ID="", 
               Sample_type="",
               Medium_Type="",
               Date_Sampled=""))
   
  rownames(specimen.codes.with.wrong.sample.ids.per.country[[1]])<-NULL
  
  print("Yes, all sample IDs provided have the correct format")}


```
#
## ENVIRONMENTAL SAMPLE IDS UNDER A SINGLE EVENT
#
#
#### Are the environmental sample IDs under a single event?
#
#
```{r envinronmental sample ids under single event, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


env.spec.sample.ids.in.more.one.event=
  dat$env_spec %>% 
  filter(!is.na(environmental_specimen_sample_id))%>%
  distinct(event_code, environmental_specimen_sample_id) %>% 
  count(environmental_specimen_sample_id) %>% 
  filter(n>1)%>%
  pull(environmental_specimen_sample_id)

env.spec.sample.ids.in.more.one.event=
  dat$env_spec %>% 
  filter(environmental_specimen_sample_id %in% env.spec.sample.ids.in.more.one.event) %>% 
  dplyr::select(country, event_code, environmental_specimen_code, environmental_specimen_sample_id) %>% 
  distinct() %>% 
  arrange(environmental_specimen_sample_id)

if(nrow(env.spec.sample.ids.in.more.one.event)>0){  

env.spec.sample.ids.in.more.one.event.df=
  env.spec.sample.ids.in.more.one.event%>%
  group_by(country, environmental_specimen_sample_id) %>%
  dplyr::summarise(
    event_codes = paste(event_code, collapse = ", "), 
    environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some environmenral samples ids ahave been used in more than one event. These are the environmental sample ids used in more than one event")
  
  kableExtra::kbl(env.spec.sample.ids.in.more.one.event.df, 
                  caption = "Environmental sample ids used in more than one event")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all the envrionemtnal sample ids are used in a single event")}


```
#
## ENVIRONMENTAL SAMPLE IDS UNDER A SINGLE ENVIRONMENTAL SPECIMEN
#
#
#### Are environmental sample IDs under a single environmental specimen?
#
#
```{r env sample ids under single specimen, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}

env.spec.sample.ids.in.more.one.env.spec=
  dat$env_spec %>% 
  filter(!is.na(environmental_specimen_sample_id))%>%
  distinct(event_code, environmental_specimen_code, environmental_specimen_sample_id) %>% 
  count(environmental_specimen_sample_id) %>% 
  filter(n>1)%>%
  pull(environmental_specimen_sample_id)

env.spec.sample.ids.in.more.one.env.spec=
  dat$env_spec %>% 
  filter(environmental_specimen_sample_id %in% env.spec.sample.ids.in.more.one.env.spec) %>% 
  dplyr::select(country, event_code, environmental_specimen_code, environmental_specimen_sample_id) %>% 
  distinct() %>% 
  arrange(environmental_specimen_sample_id)

if(nrow(env.spec.sample.ids.in.more.one.env.spec)>0){  

env.spec.sample.ids.in.more.one.env.spec.df=
  env.spec.sample.ids.in.more.one.env.spec%>%
  group_by(country, event_code, environmental_specimen_sample_id) %>%
  dplyr::summarise(
    environmental_specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some environmental sample ids have been used in more than one environmental specimen. These are the environmentl samples ids used in more than one environmentnal specimen")
  
  kableExtra::kbl(env.spec.sample.ids.in.more.one.env.spec.df, 
                  caption = "Environmental sample ids in more than one environmental specimen")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all the environamental sample ids are used in a single environmental specimen")}


```
#
## ENVIRONMENTAL SAMPLE QUANTITIES PROVIDED
#
#
#### Are the envinromental sample quantities provided?
#
#
```{r environmental sample quantity provided, echo=FALSE, warning=FALSE, eval=T, cache=F, message=F}

environmental.sample.quantity.provided=
dat$env_spec %>% 
  filter(is.na(quantity) & !is.na(environmental_specimen_sample_id)) %>% 
  dplyr::select(country, 
                event_code, 
                environmental_specimen_code, 
                environmental_specimen_sample_id, 
                quantity) %>% 
  distinct()

if(nrow(environmental.sample.quantity.provided)>0){  

environmental.sample.quantity.provided.df=
  environmental.sample.quantity.provided %>% 
   group_by(country, event_code, environmental_specimen_code) %>%
  dplyr::summarise(environ_sample_ids = paste(environmental_specimen_sample_id, collapse = ", "))%>% 
  arrange(country)  

  
  print("No. The data have environmental samples without their quantities.These are the environmental samples whose quantity is not provided." )
  
  kableExtra::kbl(environmental.sample.quantity.provided.df, 
                  caption = "Environmental sample IDs without the quantity provided")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes. All environmental sample quantities are provided")}
```
#
## ENVIRONMENTAL SAMPLE QUANTITIES PROVIDED INFORMATIVE
#
#
#### Are the environmental sample quantities provided informative?
#
#
```{r environmental sample quantity informative, echo=FALSE, warning=FALSE, eval=T, cache=F, message=F}


env.sample.quantity.not.informative=
dat$env_spec %>% 
  filter(!is.na(quantity) & quantity %in% c("0 gram", "1 gran", "1 paper", "2-3 feces pilets")) %>% 
  dplyr::select(country, event_code, environmental_specimen_code, 
                environmental_specimen_sample_id,
                quantity) %>% 
  distinct()

if(nrow(env.sample.quantity.not.informative)>0){  

env.sample.quantity.not.informative.df=
  env.sample.quantity.not.informative %>% 
   group_by(country, event_code, environmental_specimen_code) %>%
  dplyr::summarise(environ_sample_ids = paste(environmental_specimen_sample_id, collapse = ", "))%>% 
  arrange(country)  

  
  print("No. The data have environmental sample quantities that are not informative.These are the environmental samples whose quantity is not informative." )
  
  kableExtra::kbl(env.sample.quantity.not.informative.df, 
                  caption = "Envinonmental sample IDs that do not have an informative quantity")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes. All the environmental sample quantities provided are informative.")}
```
#
## ENVIRONMENTAL SAMPLES NOT USED IN TESTS (YET?) BUT MORE THAN ONCE PER ENVIRONMENTAL SPECIMEN
#
#
#### Are all environmental samples that have not used in tests (yet) unique per environmental specimen?
there should be a single data point for these environmental sample ids and no more 
#
#
```{r repeated environmental samples without tests dates, echo=FALSE, warning=FALSE, eval=T}

#how can sample id be repeated within the same specimen

#at least two rows, none of them with disease test: always problematic because it means the sample id is repeated for different tissue and any of them has been used for a test

env.samples.no.test.but.repeated= dat$env_spec %>% 
  select(country, 
         event_code, 
         environmental_specimen_code, 
         environmental_specimen_sample_id, 
         disease) %>%
  filter(is.na(disease) & !is.na(environmental_specimen_sample_id)) %>% 
  count(country, 
        event_code, 
        environmental_specimen_code, 
        environmental_specimen_sample_id) %>%
  filter(n>1) %>% 
  select(country, 
         event_code, 
         environmental_specimen_code, 
         environmental_specimen_sample_id)

if(nrow(env.samples.no.test.but.repeated)>0){  

env.samples.no.test.but.repeated.df=
  env.samples.no.test.but.repeated %>% 
   group_by(country, event_code, environmental_specimen_code) %>%
  dplyr::summarise(environmental_specimen_sample_ids = 
                     paste(environmental_specimen_sample_id, collapse = ", "))%>% 
  arrange(country)  

  
  print("The data have environmental sample ids that are repeated for a specific environmental specimen but that have not been used for any tests. These environmental sample ids are used in more than one environmental sample and should have a '.number' after the id follwoing the guidelines here https://docs.google.com/document/d/1qdrUJKN234as7Xd5E6_7QewT6l5hQ940/edit. These are the environmental sample ids not used for any test so far but repeated for a environmental specimen." )
  
  kableExtra::kbl(env.samples.no.test.but.repeated.df, 
                  caption = "Environmental specimen codes with repeated senvironmental sample ids that have not been used in any test")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("None of the environmental specimens have repeated environmental samples that have not been used for any test")}
```
#
## ENVIRONMENTAL SAMPLE ID WITH AND WITHOUT TEST UNDER A SINGLE ENVIRONMENTAL SPECIMEN
#
#
#### Are environmental sample IDs associated and not associated with tests?
There should be a single data point only for these environmental sample id associated with a test and not more. The row with the environmental sample id wo test should not exist 
#
```{r repeated envinromental samples with and without tests single environmental specimen, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

#at least two rows, one of them with disease test and the other not:  always problematic because the row without disease test should not be present: sample id is repeated for a sample not used in a test and for a sample that was used in at least one test.

temp=
dat$env_spec %>% 
  select(country, 
         event_code, 
         environmental_specimen_code,
         environmental_specimen_sample_id,
         disease) %>%
  filter(!is.na(environmental_specimen_sample_id)) %>% 
  nest(data=c(disease)) %>%
  filter(map_int(data, nrow)>1)   # filtering out groups whose data (disease) has a single row.
indexing.env.samples.diseases.and.not.diseases=
map_lgl(temp$data, function(x) any(is.na(x$disease)) & any(!is.na(x$disease)))

env.samples.with.test.and.wo.test=
  temp %>% 
  filter(indexing.env.samples.diseases.and.not.diseases) %>% 
  select(country, event_code, environmental_specimen_code, environmental_specimen_sample_id, data) 

if(nrow(env.samples.with.test.and.wo.test)>0){  

env.samples.with.test.and.wo.test.df=
  env.samples.with.test.and.wo.test %>% 
  group_by(country, event_code, environmental_specimen_code) %>%
  dplyr::summarise(
    env_sample_ids = paste(environmental_specimen_sample_id, collapse = ", "))%>% 
  arrange(country)  

  print("The data have environmental specimens with envinromental sample ids that contain at least two tests and one of them does not have a specified disease. This means that the two rows are from independent environmental samples and that the environmetal sample id is repeated for more than one environmental sample." )
  
  kableExtra::kbl(env.samples.with.test.and.wo.test.df, 
                  caption = "Envrinomental sample ids are repeated for at least two environmental samples, some of them with a test and some without a test")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("None of the environmental specimens have repeated environmental sample ids that have and have not been used for a test")}

```

## SUMMARY ISSUES AT THE ENVIRONMENTAL SPECIMENS SAMPLES LEVEL
#
"Yes" cells indicate problems for the item specified in the corresponding column name.

```{r issues environmental specimen samples level, echo=FALSE, warning=FALSE, eval=T, cache=F}


env.sample.date.collected.earlier.than.event.date$Sampling_date_before_event="Yes"

env.sample.date.collected.earlier.than.specimen.found$Sampling_date_before_specimen_found="Yes"

env.spec.sample.ids.provided$No_sample_id_provided="Yes"

env.spec.sample.ids.in.more.one.event$Sample_id_for_more_one_event="Yes"

env.spec.sample.ids.in.more.one.env.spec$Sample_id_more_one_spec="Yes"

environmental.sample.quantity.provided$Sample_quantity_missing="Yes"

env.sample.quantity.not.informative$Sample_quantity_not_informative="Yes"

env.samples.no.test.but.repeated$Repeated_sample="Yes"

env.samples.with.test.and.wo.test$Repeated_sample_2="Yes"


# data showing the issues per event code per country
env.specimen.sample.codes.with.issues=full_join(env.sample.date.collected.earlier.than.event.date, 
                                  env.sample.date.collected.earlier.than.specimen.found,
                                  by=c("country", "event_code", "environmental_specimen_code", "environmental_specimen_sample_id"))

env.specimen.sample.codes.with.issues=full_join(env.specimen.sample.codes.with.issues,
                                  env.spec.sample.ids.provided,
                                  by=c("country", "event_code", "environmental_specimen_code"))

env.specimen.sample.codes.with.issues=full_join(env.specimen.sample.codes.with.issues,
                                  env.spec.sample.ids.in.more.one.event,
                                  by=c("country", "event_code", "environmental_specimen_code", "environmental_specimen_sample_id"))

env.specimen.sample.codes.with.issues=full_join(env.specimen.sample.codes.with.issues,
                                  env.spec.sample.ids.in.more.one.env.spec, 
                                  by=c("country", "event_code", "environmental_specimen_code", "environmental_specimen_sample_id"))


env.specimen.sample.codes.with.issues=full_join(env.specimen.sample.codes.with.issues,
                                  environmental.sample.quantity.provided %>% select(-quantity), 
                                  by=c("country", "event_code", "environmental_specimen_code", "environmental_specimen_sample_id"))



env.specimen.sample.codes.with.issues=full_join(env.specimen.sample.codes.with.issues,
                                  env.sample.quantity.not.informative %>%  select(-quantity), 
                                  by=c("country", "event_code", "environmental_specimen_code", "environmental_specimen_sample_id"))


env.specimen.sample.codes.with.issues=full_join(env.specimen.sample.codes.with.issues,
                                  env.samples.no.test.but.repeated, 
                                  by=c("country", "event_code", "environmental_specimen_code", "environmental_specimen_sample_id"))


env.specimen.sample.codes.with.issues=full_join(env.specimen.sample.codes.with.issues,
                                  env.samples.with.test.and.wo.test %>% select(-data), 
                                  by=c("country", "event_code", "environmental_specimen_code", "environmental_specimen_sample_id"))




env.specimen.sample.codes.with.issues=env.specimen.sample.codes.with.issues %>% arrange(country, event_code, environmental_specimen_code, environmental_specimen_sample_id)


if(nrow(env.specimen.sample.codes.with.issues)>0){
  
      # removing columns were everything is NA
env.specimen.sample.codes.with.issues=env.specimen.sample.codes.with.issues%>%dplyr::select_if(~ !all(is.na(.)))
  
  
if(any(is.na(env.specimen.sample.codes.with.issues))){env.specimen.sample.codes.with.issues[is.na(env.specimen.sample.codes.with.issues)]="No"}
  
print("Please scroll down the table below to see the complete dataset")  
  
 kableExtra::kbl(env.specimen.sample.codes.with.issues,
                  caption = "Environmental specimens sample codes with problems") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(c(2:ncol(env.specimen.sample.codes.with.issues)), border_right = T, width = "8em")%>%

    # kableExtra::collapse_rows(1)
    scroll_box(width = "100%", height = "600px")

}else{
  
  print("No environemtnal specimen samples present problems")}  

```
#
## ENVIRONMENTAL SPECIMENS WITHOUT SAMPLE INVENTORY
#
#
#### Are there environmental specimens without sample inventory in WHIP? 
#
The environmental specimens that match this condition do not have any environmental specimen samples. Complete the environmental sample inventory.

```{r environmental specimens wo sample inventory, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

list.of.env.specimens.wo.sample.inventory=
dat$env_spec %>% select(country, environmental_specimen_code, environmental_specimen_type, date_sampled, meta_has_environmental_specimen_sample_inventory)%>% # date sampled is mandatory
  distinct()%>%
  arrange(country, environmental_specimen_code)%>%
  filter(meta_has_environmental_specimen_sample_inventory=="No")


if(nrow(list.of.env.specimens.wo.sample.inventory)>0){  

list.of.env.specimens.wo.sample.inventory.df=
  list.of.env.specimens.wo.sample.inventory %>% 
   group_by(country, environmental_specimen_code) %>%
  dplyr::summarise(
    specimen_codes = paste(environmental_specimen_code, collapse = ", ")) %>% 
  arrange(country) 

  
  print("The data have environmental specimens that could be observations. These are the environmental specimen codes that could be observations")
  
  kableExtra::kbl(list.of.env.specimens.wo.sample.inventory.df, 
                  caption = "Environmentql specimen without sample inventory")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("All the environmental specimens have sample inventory")}

```
#
# ENVIRONMENTAL SPECIMEN TESTS
#
#
## TESTS SENT FOR TESTING SINCE THE EVENT DATE
#
#### Were the tests sent for testing since the event date?
#
```{r environmental tests sent since event date, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


env.test.sent.testing.earlier.than.event.date=
  dat$env_spec %>% 
    filter(!is.na(sent_for_testing) & !is.na(event_date))%>%
    filter(!(as.Date(sent_for_testing) >= as.Date(event_date)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(env.test.sent.testing.earlier.than.event.date)>0){  

env.test.sent.testing.earlier.than.event.date.df=
  env.test.sent.testing.earlier.than.event.date%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(env_sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests were sent for testing before the event date. These are the tests that were sent for testing before the event date")
  
  kableExtra::kbl(env.test.sent.testing.earlier.than.event.date.df, 
                  caption = "Tests sent for testing before the event date")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests were sent for testing since the event date")}

```
#
#
## TESTS SENT FOR TESTING SINCE THE TESTED ENVIRONMENTAL SPECIMEN WAS FOUND
#
#### Were the tests sent for testing since the source environmental specimens was found?
#
```{r tests sent since env specimen found, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.sent.testing.earlier.than.env.specimen.found=
  dat$env_spec %>% 
    filter(!is.na(sent_for_testing) & !is.na(environmental_specimen_date_found))%>%
    filter(!(as.Date(sent_for_testing) >= as.Date(environmental_specimen_date_found)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease, sample_source)%>%
    distinct()

if(nrow(test.sent.testing.earlier.than.env.specimen.found)>0){  

test.sent.testing.earlier.than.env.specimen.found.df=
  test.sent.testing.earlier.than.env.specimen.found%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(env_sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests were sent for testing before the tested environmental specimen was found. These are the tests that were sent for testing before the tested environmental specimen was found")
  
  kableExtra::kbl(test.sent.testing.earlier.than.env.specimen.found.df, 
                  caption = "Tests sent for testing before the tested environmental specimen was found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests were sent for testing since the event date")}

```
#
#
## TESTS SENT FOR TESTING SINCE THE ENVIRONMENTAL SAMPLE SOURCE WAS COLLECTED
#
#### Were the tests sent for testing since the environmental sample source was collected?
#
```{r tests sent since env sample collected, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


env.test.sent.testing.earlier.than.sampling.date=
  dat$env_spec %>% 
    filter(!is.na(sent_for_testing) & !is.na(date_sampled))%>%
    filter(!(as.Date(sent_for_testing) >= as.Date(date_sampled)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(env.test.sent.testing.earlier.than.sampling.date)>0){  

env.test.sent.testing.earlier.than.sampling.date.df=
  env.test.sent.testing.earlier.than.sampling.date%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(env_sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests were sent for testing before the environmental sample source was collected. These are the tests that were sent for testing before the environmental sample source was collected")
  
  kableExtra::kbl(env.test.sent.testing.earlier.than.sampling.date.df, 
                  caption = "Tests sent for testing before the environmental sample collection")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests were sent for testing since the environmental sample collection")}

```
#
#
## TESTS RESULTS RECEIVED SINCE THE EVENT DATE
#
#### Were the tests results received since the event date?
#
```{r env tests results since event date, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


env.test.results.received.earlier.than.event.date=
  dat$env_spec %>% 
    filter(!is.na(disease_inventory_results_received) & !is.na(event_date))%>%
    filter(!(as.Date(disease_inventory_results_received) >= as.Date(event_date)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(env.test.results.received.earlier.than.event.date)>0){  

env.test.results.received.earlier.than.event.date.df=
  env.test.results.received.earlier.than.event.date%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests results were received before the event date. These are the tests results that were received before the event date")
  
  kableExtra::kbl(env.test.results.received.earlier.than.event.date.df, 
                  caption = "Tests results received before the event date")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests results were received since the event date")}

```
#
#
## TESTS RESULTS RECEIVED SINCE THE TESTED ENVINROMENTAL SPECIMEN WAS FOUND
#
#### Were the tests results received since the source envinromental specimens were found?
#
```{r tests results since env specimen found, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


test.results.earlier.than.env.specimen.found=
  dat$env_spec %>% 
    filter(!is.na(disease_inventory_results_received) & !is.na(environmental_specimen_date_found))%>%
    filter(!(as.Date(disease_inventory_results_received) >= as.Date(environmental_specimen_date_found)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease, sample_source)%>%
    distinct()

if(nrow(test.results.earlier.than.specimen.found)>0){  

test.results.earlier.than.specimen.found.df=
  test.results.earlier.than.specimen.found%>%
  group_by(country, event_code, specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests results were received before the tested environmental specimen was found. These are the tests results that were received before the tested environmental specimen was found")
  
  kableExtra::kbl(test.results.earlier.than.specimen.found.df, 
                  caption = "Tests results received before the tested  environmental specimen was found")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests results were received since the event date")}

```
#
#
## TESTS RESULTS RECEIVED SINCE THE ENVIRONMENTAL SAMPLE SOURCE WAS COLLECTED
#
#### Were the tests results received since the environmental sample source was collected?
#
```{r tests results since environmental sample collected, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


env.test.results.earlier.than.sampling.date=
  dat$env_spec %>% 
    filter(!is.na(disease_inventory_results_received) & !is.na(date_sampled))%>%
    filter(!(as.Date(disease_inventory_results_received) >= as.Date(date_sampled)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(env.test.results.earlier.than.sampling.date)>0){  

env.test.results.earlier.than.sampling.date.df=
  env.test.results.earlier.than.sampling.date%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests results were received before the environmental sample source was collected. These are the tests results that were received before the environmental sample source was collected")
  
  kableExtra::kbl(env.test.results.earlier.than.sampling.date.df, 
                  caption = "Tests results received before the environmental sample collection")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests results were received since the environmental sample collection")}

```
#
#
## TESTS RESULTS RECEIVED SINCE THE TESTS WERE SENT
#
#### Were the tests results received since the test was sent?
#
```{r env tests results since test sent, echo=FALSE, warning=FALSE, eval=T, cache=F, message=FALSE}


env.test.results.earlier.than.test.sent=
  dat$env_spec %>% 
    filter(!is.na(disease_inventory_results_received) & !is.na(sent_for_testing))%>%
    filter(!(as.Date(disease_inventory_results_received) >= as.Date(sent_for_testing)))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease, sample_source)%>%
    distinct()


if(nrow(env.test.results.earlier.than.test.sent)>0){  

env.test.results.earlier.than.test.sent.df=
  env.test.results.earlier.than.test.sent%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests results were received before the test was sent for testing. These are the tests results that were received before the test was sent")
  
  kableExtra::kbl(env.test.results.earlier.than.test.sent.df, 
                  caption = "Environmental tests results received before tests were sent")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests results were received since the tests were sent")}

```
#
#
## TESTS WITHOUT THE SOURCE
#
#### Do all tests have the source provided?
#
```{r env tests source, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.test.source.not.provided=
  dat$env_spec %>% 
    filter(is.na(sample_source) & !is.na(disease))%>%
    dplyr::select(country, event_code, environmental_specimen_code, sample_source, disease)%>%
    distinct()


if(nrow(env.test.source.not.provided)>0){  

env.test.source.not.provided.df=
  env.test.source.not.provided%>%
  group_by(country, event_code, environmental_specimen_code) %>%
  dplyr::summarise(disease_tested = paste(disease, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests do not have their sample source")
  
  kableExtra::kbl(env.test.source.not.provided.df, 
                  caption = "Tests without the sample source")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(4, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests have their sample source")}

```
#
#
## TESTS WITHOUT METHOD
#
#### Do all tests have the method provided? 
#
```{r env tests without the method provided, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.test.method.not.provided=
  dat$env_spec %>% 
  filter(!is.na(disease) &
         is.na(disease_inventory_test_method)) %>%
    dplyr::select(country, event_code, environmental_specimen_code, disease,  sample_source)%>%
    distinct()

if(nrow(env.test.method.not.provided)>0){  

env.test.method.not.provided.df=
  env.test.method.not.provided%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  

  print("No, the data show that some tests do not have the method provided")
  
  kableExtra::kbl(env.test.method.not.provided.df, 
                  caption = "Tests without the method provided")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests have their method provided")}
```
#
#
## TESTS WITHOUT THE DATE WHEN THEY WERE SENT FOR TESTING
#
#### Do all tests that a result, result received date, method, or sample source have the date when the test was sent? 
#
```{r env tests without , echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.test.sent.for.testing.date.not.provided=
  dat$env_spec %>% 
    filter(is.na(sent_for_testing)) %>% 
    filter(!is.na(disease_inventory_test_result) |
           !is.na(disease) |
           !is.na(disease_inventory_results_received) |
           !is.na(disease_inventory_test_method) |
           !is.na(sample_source))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease,  sample_source)%>%
    distinct()


if(nrow(env.test.sent.for.testing.date.not.provided)>0){  

env.test.sent.for.testing.date.not.provided.df=
  env.test.sent.for.testing.date.not.provided%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests lack the date when these tests were sent")
  
  kableExtra::kbl(env.test.sent.for.testing.date.not.provided.df, 
                  caption = "Tests with unknown date when they were sent")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests have the date when they were sent")}
```
#
#
## TESTS WITH RESULTS BUT WITHOUT THE DATE WHEN RESULTS WERE RECEIVED
#
#### Do all tests that have a "non-pending" result have the date when the results were received? 
#
```{r env tests with results but no date when results arrived, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.test.result.received.date.not.provided=
  dat$env_spec %>% 
    filter(disease_inventory_test_result!="Pending" & 
           !is.na(disease_inventory_test_result) &
           !is.na(disease) &
           is.na(disease_inventory_results_received))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease,  sample_source)%>%
    distinct()


if(nrow(env.test.result.received.date.not.provided)>0){  

env.test.result.received.date.not.provided.df=
  env.test.result.received.date.not.provided%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests have results but they lack the date when these results arrived")
  
  kableExtra::kbl(env.test.result.received.date.not.provided.df, 
                  caption = "Tests with results but unknown date when results were received")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests with results have the date when the results arrived")}
```
#
#
## TESTS WITHOUT RESULTS
#
#### Do all tests have their result? Here we scan for tests sent without results at all. Test with "Pending" results are provided in the next section.
#
```{r env tests without results, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.test.results.not.provided=
  dat$env_spec %>% 
    filter(is.na(disease_inventory_test_result) & !is.na(disease))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease,  sample_source)%>%
    distinct()


if(nrow(env.test.results.not.provided)>0){  

env.test.results.not.provided.df=
  env.test.results.not.provided%>%
  group_by(country, event_code, environmental_specimen_code, disease) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("No, the data show that some tests do not have results")
  
  kableExtra::kbl(env.test.results.not.provided.df, 
                  caption = "Tests without results")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(5, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("Yes, all tests have results")}
```
#
#
## TESTS WITH RESULTS RECEIVED FROM THE LAB BUT PENDING OR NO RESULT IN THE DATA
#
#### Do tests have pending or no results? Here we scan for tests sent to the lab, with "Pending" results but with date of results received. If the results were received then the test result should not be "pending" or NA status.
#
```{r env tests with results received but pending or na in the data, echo=FALSE, warning=FALSE, eval=T, message=FALSE}

env.test.results.pending=
  dat$env_spec %>% 
    filter(disease_inventory_test_result=="Pending" | 
           is.na(disease_inventory_test_result) & 
           !is.na(disease_inventory_results_received))%>%
    dplyr::select(country, event_code, environmental_specimen_code, disease, sample_source, 
                  disease_inventory_results_received, 
                  disease_inventory_test_result)%>%
    distinct()


if(nrow(env.test.results.pending)>0){  

env.test.results.pending.df=
  env.test.results.pending%>%
  group_by(country, event_code, environmental_specimen_code, disease, disease_inventory_results_received) %>%
  dplyr::summarise(sample_sources = paste(sample_source, collapse = ", ")) %>% 
  arrange(country)  
  
  print("Yes, the data show that some tests have their results received but they are still pending to be added to the data")
  
  kableExtra::kbl(env.test.results.pending.df, 
                  caption = "Tests with results pending")%>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2, bold = T, border_right = T) %>%
    kableExtra::column_spec(3, bold = T, border_right = T) %>%
    kableExtra::column_spec(4, bold = T, border_right = T) %>%
    kableExtra::column_spec(5, width = "30em", border_right = T) %>% 
    kableExtra::column_spec(6, width = "30em", border_right = T)%>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("No, all tests with received results from the lab have the test result different of 'Pending'")}
```
#
## SUMMARY ISSUES AT THE ENVIRONMENTAL SPECIMEN TESTS LEVEL
#
"Yes" cells indicate problems for the item specified in the corresponding column name.

```{r issues env specimen test level, echo=FALSE, warning=FALSE, eval=T, cache=F}


env.test.sent.testing.earlier.than.event.date$Test_sent_before_event="Yes"

test.sent.testing.earlier.than.env.specimen.found$Test_sent_before_specimen_found="Yes"

env.test.sent.testing.earlier.than.sampling.date$Test_sent_before_sampling="Yes"

env.test.results.received.earlier.than.event.date$Test_received_before_event="Yes"

test.results.earlier.than.env.specimen.found$Test_received_before_specimen_found="Yes"

env.test.results.earlier.than.sampling.date$Test_received_before_sampling="Yes"

env.test.results.earlier.than.test.sent$Test_received_before_test_sent="Yes"

env.test.source.not.provided$Test_source_not_provided="Yes"

env.test.method.not.provided$Test_method_not_provided="Yes"

env.test.sent.for.testing.date.not.provided$Test_sent_date_not_provided="Yes"

env.test.result.received.date.not.provided$Test_result_received_date_not_provided="Yes"

env.test.results.not.provided$Test_result_not_provided="Yes"

env.test.results.pending$Test_result_pending="Yes"


# data showing the issues per event code per country
env.specimen.tests.with.issues=full_join(env.test.sent.testing.earlier.than.event.date, 
                                  test.sent.testing.earlier.than.env.specimen.found,
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))

env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.sent.testing.earlier.than.sampling.date,
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))

env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.results.received.earlier.than.event.date,
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))

env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  test.results.earlier.than.env.specimen.found, 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))

env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.results.earlier.than.sampling.date, 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))

env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.results.earlier.than.test.sent, 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))


env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.source.not.provided, 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))

env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.method.not.provided, 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))

env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.sent.for.testing.date.not.provided, 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))


env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.result.received.date.not.provided, 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))


env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.results.not.provided, 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))

env.specimen.tests.with.issues=full_join(env.specimen.tests.with.issues,
                                  env.test.results.pending %>% select(-disease_inventory_results_received, - disease_inventory_test_result), 
                                  by=c("country", "event_code", "environmental_specimen_code", "sample_source", "disease"))



env.specimen.tests.with.issues=env.specimen.tests.with.issues %>% arrange(country, event_code, environmental_specimen_code, sample_source, disease)


if(nrow(env.specimen.tests.with.issues)>0){
  
      # removing columns were everything is NA
env.specimen.tests.with.issues=env.specimen.tests.with.issues%>%dplyr::select_if(~ !all(is.na(.)))
  
  
if(any(is.na(env.specimen.tests.with.issues))){env.specimen.tests.with.issues[is.na(env.specimen.tests.with.issues)]="No"}
  
print("Please scroll down the table below to see the complete dataset")  
  
 kableExtra::kbl(env.specimen.tests.with.issues,
                  caption = "Environmental specimen tests with problems") %>%
    kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(c(2:ncol(env.specimen.tests.with.issues)), border_right = T, width = "8em")%>%

    # kableExtra::collapse_rows(1)
    scroll_box(width = "100%", height = "600px")

}else{
  
  print("No environmental specimen test present problems")}  

```
#
## TESTS THAT COULD BE REPEATED
#
#
#### Are there tests that have the same test information. If test data is repeated twice or more it DOES NOT imply that a single test was entered in the database more than once, but it is very suggestive it was (it is possible that two tests were conducted in the same lab, using the same source, targeting the same disease, using the same method, getting the same result, and the tests could have been sent the same date, and their results received the same date. But it is also possible that it is the same test entered worngly more than once). These data needs to be double checked and not necessarily corrected.
#
```{r env tests that could be repeated same infomration, echo=FALSE, warning=FALSE, eval=T, cache=FALSE, message=FALSE}

# tests
list.of.potential.repeated.env.tests=
dat$env_spec %>% 
  filter(!is.na(sample_source)) %>% 
  select(country,
         event_code,
         environmental_specimen_code,
         testing_lab,
         sample_source, 
         disease, 
         disease_inventory_test_method, 
         sent_for_testing, 
         disease_inventory_results_received,
         disease_inventory_test_result) %>%
  group_by_all() %>% 
  summarise(times_repeated = n()) %>% 
  filter(times_repeated>1) %>%
  ungroup()
 

if(nrow(list.of.potential.repeated.env.tests)>0){  

  print("The data have tests that could be repeated. These are the tests that could be repeated")
  
  kableExtra::kbl(list.of.potential.repeated.env.tests, 
                  caption = "Tests that could be repeated")%>%
     kableExtra::kable_paper(full_width = F) %>%
    kableExtra::column_spec(1, bold = T, border_right = T) %>%
    kableExtra::column_spec(2:4, border_right = T) %>%
    kableExtra::column_spec(5, width = "30em", bold = T, border_right = T) %>%
    kableExtra::column_spec(6:10, width = "30em", border_right = T) %>%
    scroll_box(width = "100%", height = "600px")}else{#}


  print("None of the tests seem to be repeated")}

```


